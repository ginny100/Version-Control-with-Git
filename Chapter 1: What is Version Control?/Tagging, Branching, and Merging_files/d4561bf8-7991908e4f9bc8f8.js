"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2822],{23117:function(e,t,r){function s(e,t){if("detect"in e)return e.detect(t);for(let r=0;r<e.length;r++)if(t(e[r]))return e[r]}function i(e,t){if("any"in e)return e.any(t);for(let r=0;r<e.length;r++)if(t(e[r]))return!0;return!1}function n(e,t){if("forEach"in e)e.forEach(t);else for(let r=0;r<e.length;r++)t(e[r],r)}function a(e,t){const r=[];return n(e,(e=>{t(e)&&r.push(e)})),r}function o(e,t){let r=0;for(;r<e.length&&r<t.length&&e[r]===t[r];)r++;return r}function h(e,t,r){let s=r;return n(e,((e,r)=>{s=t(s,e,r)})),s}function l(e){const t={};for(let r=0;r<e.length;r+=2){let[s,i]=[e[r],e[r+1]];t[s]=i}return t}function d(e){const t=Object.keys(e).sort(),r=[];return t.forEach((t=>{r.push(t),r.push(e[t])})),r}function c(e,t){let r=e.length;if(r!==t.length)return!1;for(let s=0;s<r;s++)if(e[s]!==t[s])return!1;return!0}function u(e,t){return-1!==e.indexOf(t)}function p(e){return Object.keys(e).map((t=>e[t]))}r.d(t,{ML:function(){return Vs},UI:function(){return ke}});const m=1,f=3,k=8;function g(e){return e.nodeType===f}function _(e){return e.nodeType===k}function C(e){return e.nodeType===m}function b(e,t){if(e===t)return!0;return!!(e.compareDocumentPosition(t)&Node.DOCUMENT_POSITION_CONTAINED_BY)}function S(e){const t={};return e.hasAttributes()&&n(e.attributes,(({name:e,value:r})=>{t[e]=r})),t}function E(e,t){e.classList.add(t)}function A(e){return e.toLowerCase()}function y(e,t){let r=e.lastIndexOf(t);return-1!==r&&r===e.length-t.length}function M(e,t,r,s){const i=function(e){const t={left:0,top:-window.pageYOffset},r=e.offsetParent;let s;return"relative"===window.getComputedStyle(r).position&&(s=r.getBoundingClientRect(),t.left=s.left,t.top=s.top),t}(e),n=e.style,a=Math.round;let o,h;return r=r||0,s=s||0,o=a(t.left-i.left-s),h=a(t.top+t.height-i.top-r),n.left=`${o}px`,n.top=`${h}px`,{left:o,top:h}}function w(e,t){const r=function(e,t){return parseFloat(window.getComputedStyle(e)[t])}(e,"marginTop");return function(e,t,r){return M(e,t,r,e.offsetWidth/2-t.width/2)}(e,t.getBoundingClientRect(),-r)}class v{constructor(){this.markups=[],this.prev=null,this.next=null,this.isAtom=!1,this.isMarker=!1,this.section=null,this.parent=null,this.renderNode=null}charAt(e){return this.value.slice(e,e+1)}clearMarkups(){this.markups=[]}addMarkup(e){this.markups.push(e)}addMarkupAtIndex(e,t){this.markups.splice(t,0,e)}removeMarkup(e){let t;if("function"===typeof e)t=e;else{let r=e;t=e=>e===r}n(a(this.markups,t),(e=>this._removeMarkup(e)))}_removeMarkup(e){const t=this.markups.indexOf(e);-1!==t&&this.markups.splice(t,1)}hasMarkup(e){return!!this.getMarkup(e)}getMarkup(e){if("string"===typeof e){let t=A(e);return s(this.markups,(e=>e.tagName===t))}{let t=e;return s(this.markups,(e=>e===t))}}get openedMarkups(){let e=0;return this.prev&&(e=o(this.markups,this.prev.markups)),this.markups.slice(e)}get closedMarkups(){let e=0;return this.next&&(e=o(this.markups,this.next.markups)),this.markups.slice(e)}}class N extends Error{}function T(e,t){if(!t)throw new N(e)}function R(e,t,r){T(e,t in r)}function I(e,t){if(null===t)throw new N(e)}function L(e,t,r){T(e,r)}function x(e,t){if(null===e||void 0===e)throw new N(t);return e}function D(e){return x(e,"expected value to not be null or undefined")}const O=[55296,56319],P=[56320,57343];class B extends v{constructor(e="",t=[]){super(),this.type="marker",this.isMarker=!0,this.markups=[],this.renderNode=null,this.value=e,T("Marker must have value",void 0!==e&&null!==e),t.forEach((e=>this.addMarkup(e)))}clone(){const e=this.markups.slice();return this.builder.createMarker(this.value,e)}get isEmpty(){return this.isBlank}get isBlank(){return 0===this.length}get text(){return this.value}get length(){return this.value.length}deleteValueAtOffset(e){T("Cannot delete value at offset outside bounds",e>=0&&e<=this.length);let t=1,r=this.value.charCodeAt(e);r>=O[0]&&r<=O[1]?t=2:r>=P[0]&&r<=P[1]&&(t=2,e-=1);const[s,i]=[this.value.slice(0,e),this.value.slice(e+t)];return this.value=s+i,t}canJoin(e){return e&&e.isMarker&&c(this.markups,e.markups)}textUntil(e){return this.value.slice(0,e)}split(e=0,t=this.length){let r=[this.builder.createMarker(this.value.substring(0,e)),this.builder.createMarker(this.value.substring(e,t)),this.builder.createMarker(this.value.substring(t))];return this.markups.forEach((e=>r.forEach((t=>t.addMarkup(e))))),r}splitAtOffset(e){T("Cannot split a marker at an offset > its length",e<=this.length);let{value:t,builder:r}=this,s=r.createMarker(t.substring(0,e)),i=r.createMarker(t.substring(e));return this.markups.forEach((e=>{s.addMarkup(e),i.addMarkup(e)})),[s,i]}}var H={BACKSPACE:8,SPACE:32,ENTER:13,SHIFT:16,ESC:27,DELETE:46,0:48,9:57,A:65,Z:90,a:97,z:122,NUMPAD_0:186,NUMPAD_9:111,";":186,".":190,"`":192,"[":219,'"':222,IME:229,TAB:9,CLEAR:12,PAUSE:19,PAGEUP:33,PAGEDOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,INS:45,META:91,ALT:18,CTRL:17},F={BACKSPACE:"Backspace",SPACE:" ",ENTER:"Enter",SHIFT:"Shift",ESC:"Escape",DELETE:"Delete",INS:"Insert",HOME:"Home",END:"End",PAGEUP:"PageUp",PAGEDOWN:"PageDown",CLEAR:"Clear",PAUSE:"Pause",TAB:"Tab",ALT:"Alt",CTRL:"Control",LEFT:"ArrowLeft",RIGHT:"ArrowRight",UP:"ArrowUp",DOWN:"ArrowDown"};var $;!function(e){e[e.FORWARD=1]="FORWARD",e[e.BACKWARD=-1]="BACKWARD"}($||($={}));const U={META:1,CTRL:2,SHIFT:4,ALT:8};const K={BACKSPACE:H.BACKSPACE,TAB:H.TAB,ENTER:H.ENTER,ESC:H.ESC,SPACE:H.SPACE,PAGEUP:H.PAGEUP,PAGEDOWN:H.PAGEDOWN,END:H.END,HOME:H.HOME,LEFT:H.LEFT,UP:H.UP,RIGHT:H.RIGHT,DOWN:H.DOWN,INS:H.INS,DEL:H.DELETE};class W{constructor(e){this.key=e.key,this.keyCode=e.keyCode,this.charCode=e.charCode,this.event=e,this.modifierMask=function(e){let{metaKey:t,shiftKey:r,ctrlKey:s,altKey:i}=e,n=(e,t)=>e&&t||0;return n(t,U.META)+n(r,U.SHIFT)+n(s,U.CTRL)+n(i,U.ALT)}(e)}static fromEvent(e){return T("Must pass a Key event to Key.fromEvent",e&&function(e){return/^key/.test(e.type)}(e)),new W(e)}toString(){return this.isTab()?"\t":String.fromCharCode(this.charCode)}isKeySupported(){return this.key}isKey(e){return this.isKeySupported()?(T(`Must define Keys.${e}.`,!!F[e]),this.key===F[e]):(T(`Must define Keycodes.${e}.`,!!H[e]),this.keyCode===H[e])}isEscape(){return this.isKey("ESC")}isDelete(){return this.isKey("BACKSPACE")||this.isForwardDelete()}isForwardDelete(){return this.isKey("DELETE")}isArrow(){return this.isHorizontalArrow()||this.isVerticalArrow()}isHorizontalArrow(){return this.isLeftArrow()||this.isRightArrow()}isHorizontalArrowWithoutModifiersOtherThanShift(){return this.isHorizontalArrow()&&!(this.ctrlKey||this.metaKey||this.altKey)}isVerticalArrow(){return this.isKey("UP")||this.isKey("DOWN")}isLeftArrow(){return this.isKey("LEFT")}isRightArrow(){return this.isKey("RIGHT")}isHome(){return this.isKey("HOME")}isEnd(){return this.isKey("END")}isPageUp(){return this.isKey("PAGEUP")}isPageDown(){return this.isKey("PAGEDOWN")}isInsert(){return this.isKey("INS")}isClear(){return this.isKey("CLEAR")}isPause(){return this.isKey("PAUSE")}isSpace(){return this.isKey("SPACE")}isTab(){return!this.hasAnyModifier()&&this.isKey("TAB")}isEnter(){return this.isKey("ENTER")}isShiftKey(){return this.isKey("SHIFT")}isAltKey(){return this.isKey("ALT")}isCtrlKey(){return this.isKey("CTRL")}isIME(){return this.keyCode===H.IME}get direction(){switch(!0){case this.isDelete():return this.isForwardDelete()?$.FORWARD:$.BACKWARD;case this.isHorizontalArrow():return this.isRightArrow()?$.FORWARD:$.BACKWARD;default:return $.FORWARD}}isShift(){return this.shiftKey}hasModifier(e){return e&this.modifierMask}hasAnyModifier(){return!!this.modifierMask}get ctrlKey(){return U.CTRL&this.modifierMask}get metaKey(){return U.META&this.modifierMask}get shiftKey(){return U.SHIFT&this.modifierMask}get altKey(){return U.ALT&this.modifierMask}isPrintableKey(){return!(this.isArrow()||this.isHome()||this.isEnd()||this.isPageUp()||this.isPageDown()||this.isInsert()||this.isClear()||this.isPause()||this.isEscape())}isNumberKey(){if(this.isKeySupported())return this.key>="0"&&this.key<="9";{const e=this.keyCode;return e>=H[0]&&e<=H[9]||e>=H.NUMPAD_0&&e<=H.NUMPAD_9}}isLetterKey(){if(this.isKeySupported()){const e=this.key;return e>="a"&&e<="z"||e>="A"&&e<="Z"}{const e=this.keyCode;return e>=H.A&&e<=H.Z||e>=H.a&&e<=H.z}}isPunctuation(){if(this.isKeySupported()){const e=this.key;return e>=";"&&e<="`"||e>="["&&e<='"'}{const e=this.keyCode;return e>=H[";"]&&e<=H["`"]||e>=H["["]&&e<=H['"']}}isPrintable(){return!this.ctrlKey&&!this.metaKey&&(!!this.isPrintableKey()&&(0!==this.keyCode||this.toString().length>0||this.isNumberKey()||this.isSpace()||this.isTab()||this.isEnter()||this.isLetterKey()||this.isPunctuation()||this.isIME()))}}function j(e){let t=document.createRange();return t.setEnd(e,e.nodeValue.length),t.setStart(e,0),t.getClientRects()}function q(e,t){let r,s,i=1e8,n=0;for(let a=e.firstChild;a;a=a.nextSibling){let e;if(C(a))e=a.getClientRects();else{if(!g(a))continue;e=j(a)}for(let o=0;o<e.length;o++){let h=e[o];if(h.left<=t.left&&h.right>=t.left){let e=h.top>t.top?h.top-t.top:h.bottom<t.top?t.top-h.bottom:0;if(e<i){r=a,i=e,s=e?{left:t.left,top:h.top}:t,C(a)&&!a.firstChild&&(n=o+(t.left>=(h.left+h.right)/2?1:0));continue}}!r&&(t.top>=h.bottom||t.top>=h.top&&t.left>=h.right)&&(n=o+1)}}return r?g(r)?function(e,t){let r=e.nodeValue.length,s=document.createRange();for(let i=0;i<r;i++){s.setEnd(e,i+1),s.setStart(e,i);let r=s.getBoundingClientRect();if(r.top!==r.bottom&&r.left<=t.left&&r.right>=t.left&&r.top<=t.top&&r.bottom>=t.top)return{node:e,offset:i+(t.left>=(r.left+r.right)/2?1:0)}}return{node:e,offset:0}}(r,s):r.firstChild?q(r,s):{node:e,offset:n}:{node:e,offset:n}}function G(e,t,r){let s=t.compareDocumentPosition(e);if(s&Node.DOCUMENT_POSITION_CONTAINED_BY)return{node:e,offset:r};if(s&Node.DOCUMENT_POSITION_CONTAINS)return{node:e,offset:r};if(s&Node.DOCUMENT_POSITION_PRECEDING){let e=t.firstChild;for(;e&&e.firstChild;)e=e.firstChild;return{node:e,offset:0}}if(s&Node.DOCUMENT_POSITION_FOLLOWING){let e=t.lastChild;for(;e.lastChild;)e=e.lastChild;return{node:e,offset:g(e)?e.textContent.length:1}}return{node:e,offset:r}}function V(e){I("selection anchorNode should not be null",e.anchorNode),I("selection focusNode should not be null",e.focusNode);let t,r,s,i,n,{anchorNode:a,focusNode:o,anchorOffset:h,focusOffset:l}=e;const d=a.compareDocumentPosition(o);if(d&Node.DOCUMENT_POSITION_CONTAINS){if(l<o.childNodes.length)o=o.childNodes[l],l=0;else{for(;o.lastChild;)o=o.lastChild;l=o.textContent.length}return V({focusNode:o,focusOffset:l,anchorNode:a,anchorOffset:h})}if(d&Node.DOCUMENT_POSITION_CONTAINED_BY){let e=h-1;return e<0&&(e=0),V({anchorNode:a.childNodes[e],anchorOffset:0,focusNode:o,focusOffset:l})}return d&Node.DOCUMENT_POSITION_FOLLOWING?(t=a,r=o,s=h,i=l,n=$.FORWARD):d&Node.DOCUMENT_POSITION_PRECEDING?(t=o,r=a,s=l,i=h,n=$.BACKWARD):(t=r=a,s=h,i=l,i<s?(s=l,i=h,n=$.BACKWARD):n=s<i?$.FORWARD:null),{headNode:t,headOffset:s,tailNode:r,tailOffset:i,direction:n}}class z{constructor(e,t=e,r=null){this.head=e,this.tail=t,this.direction=r}static create(e,t,r=e,s=t,i=null){return new z(new ce(e,t),new ce(r,s),i)}static blankRange(){return new z(ce.blankPosition(),ce.blankPosition())}trimTo(e){const t=e.length;let r=e===this.head.section?Math.min(this.head.offset,t):0,s=e===this.tail.section?Math.min(this.tail.offset,t):t;return z.create(e,r,e,s)}extend(e){if(T("Must pass integer to Range#extend","number"===typeof e),0===e)return this;let{head:t,tail:r,direction:s}=this;switch(s){case $.FORWARD:return new z(t,r.move(e),s);case $.BACKWARD:return new z(t.move(e),r,s);default:{let s=e>0?$.FORWARD:$.BACKWARD;return new z(t,r,s).extend(e)}}}move(e){T(`Must pass DIRECTION.FORWARD (${$.FORWARD}) or DIRECTION.BACKWARD (${$.BACKWARD}) to Range#move`,e===$.FORWARD||e===$.BACKWARD);let{focusedPosition:t,isCollapsed:r}=this;return r?new z(t.move(e)):this._collapse(e)}expandByMarker(e){let{head:t,tail:r,direction:s}=this,{section:i}=t;if(I("expected range section to not be null",i),J(i),i!==r.section)throw new Error("#expandByMarker does not work across sections. Perhaps you should confirm the range is collapsed");let n=t=>!e(t),a=i.markers.detect(n,t.marker,!0);a=!a&&e(i.markers.head)?i.markers.head:D(a).next||t.marker;let o=new ce(i,i.offsetOfMarker(D(a)));J(r.section);let h=r.section.markers.detect(n,r.marker);h=!h&&e(D(i.markers.tail))?D(i.markers.tail):D(h).prev||D(r.marker);let l=new ce(r.section,r.section.offsetOfMarker(h)+h.length);return o.toRange(l,s)}_collapse(e){return new z(e===$.BACKWARD?this.head:this.tail)}get focusedPosition(){return this.direction===$.BACKWARD?this.head:this.tail}isEqual(e){return e&&this.head.isEqual(e.head)&&this.tail.isEqual(e.tail)}get isBlank(){return this.head.isBlank&&this.tail.isBlank}get headSection(){return this.head.section}get tailSection(){return this.tail.section}get headSectionOffset(){return this.head.offset}get tailSectionOffset(){return this.tail.offset}get isCollapsed(){return this.head.isEqual(this.tail)}get headMarker(){return this.head.marker}get tailMarker(){return this.tail.marker}get headMarkerOffset(){return this.head.offsetInMarker}get tailMarkerOffset(){return this.tail.offsetInMarker}}function J(e){if(!("markers"in e))throw new N("Expected position section to be markerable")}class Q{constructor(){this.next=null,this.prev=null}}function Y(e){return"items"in e&&e.items}class Z extends Q{constructor(e){super(),this.isSection=!0,this.isMarkerable=!1,this.isNested=!1,this.isListItem=!1,this.isListSection=!1,this.isLeafSection=!0,this.isCardSection=!1,this._parent=null,T("Cannot create section without type",!!e),this.type=e}get parent(){return x(this._parent,"expected section parent to be assigned")}get isBlank(){return!1}get length(){return 0}headPosition(){return this.toPosition(0)}tailPosition(){return this.toPosition(this.length)}toPosition(e){return T("Must pass number to `toPosition`","number"===typeof e),T("Cannot call `toPosition` with offset > length",e<=this.length),new ce(this,e)}toRange(){return this.headPosition().toRange(this.tailPosition())}splitMarkerAtOffset(e){return{added:[],removed:[]}}nextLeafSection(){const e=this.next;return e?Y(e)?e.items.head:e:X(this)?this.parent.nextLeafSection():null}immediatelyNextMarkerableSection(){let e=this.nextLeafSection();for(;e&&!e.isMarkerable;)e=e.nextLeafSection();return e}previousLeafSection(){const e=this.prev;return e?Y(e)?e.items.tail:e:X(this)?this.parent.previousLeafSection():null}}function X(e){return e.isNested}var ee;!function(e){e.DISPLAY="display",e.EDIT="edit"}(ee||(ee={}));function te(e){return e.isCardSection}class re extends Z{constructor(e,t){super("card-section"),this._initialMode=ee.DISPLAY,this.isCardSection=!0,this.name=e,this.payload=t,this.isCardSection=!0}textUntil(){return""}canJoin(){return!1}get length(){return 1}clone(){let e=(t=this.payload,{...t});var t;let r=this.builder.createCardSection(this.name,e),s=this._initialMode;return this.renderNode&&this.renderNode.cardNode&&(s=this.renderNode.cardNode.mode),r.setInitialMode(s),r}setInitialMode(e){this._initialMode=e}}class se extends v{constructor(e,t,r,s=[]){super(),this.type="atom",this.isAtom=!0,this.name=e,this.value=t,this.text="",T("Atom must have value",void 0!==t&&null!==t),this.payload=r,this.type="atom",this.isMarker=!1,this.isAtom=!0,this.markups=[],s.forEach((e=>this.addMarkup(e)))}clone(){let e=this.markups.slice();return this.builder.createAtom(this.name,this.value,this.payload,e)}get isBlank(){return!1}get length(){return 1}canJoin(){return!1}textUntil(){return""}split(e=0,t=e){let r=[];return 0===t&&r.push(this.builder.createMarker("",this.markups.slice())),r.push(this.clone()),1===e&&r.push(this.builder.createMarker("",this.markups.slice())),r}splitAtOffset(e){T("Cannot split a marker at an offset > its length",e<=this.length);let t,r,{builder:s}=this,i=this.clone(),n=s.createMarker("");return 0===e?[t,r]=[n,i]:1===e?[t,r]=[i,n]:T(`Invalid offset given to Atom#splitAtOffset: "${e}"`,!1),this.markups.forEach((e=>{t.addMarkup(e),r.addMarkup(e)})),[t,r]}}function ie(e){return"atom"===e.type}const{FORWARD:ne,BACKWARD:ae}=$,oe=/[A-Za-z\xaa\xb5\xba\xc0-\xd6\xd8-\xf6\xf8-\u02c1\u02c6-\u02d1\u02e0-\u02e4\u02ec\u02ee\u0345\u0370-\u0374\u0376\u0377\u037a-\u037d\u037f\u0386\u0388-\u038a\u038c\u038e-\u03a1\u03a3-\u03f5\u03f7-\u0481\u048a-\u052f\u0531-\u0556\u0559\u0561-\u0587\u05b0-\u05bd\u05bf\u05c1\u05c2\u05c4\u05c5\u05c7\u05d0-\u05ea\u05f0-\u05f2\u0610-\u061a\u0620-\u0657\u0659-\u065f\u066e-\u06d3\u06d5-\u06dc\u06e1-\u06e8\u06ed-\u06ef\u06fa-\u06fc\u06ff\u0710-\u073f\u074d-\u07b1\u07ca-\u07ea\u07f4\u07f5\u07fa\u0800-\u0817\u081a-\u082c\u0840-\u0858\u08a0-\u08b4\u08e3-\u08e9\u08f0-\u093b\u093d-\u094c\u094e-\u0950\u0955-\u0963\u0971-\u0983\u0985-\u098c\u098f\u0990\u0993-\u09a8\u09aa-\u09b0\u09b2\u09b6-\u09b9\u09bd-\u09c4\u09c7\u09c8\u09cb\u09cc\u09ce\u09d7\u09dc\u09dd\u09df-\u09e3\u09f0\u09f1\u0a01-\u0a03\u0a05-\u0a0a\u0a0f\u0a10\u0a13-\u0a28\u0a2a-\u0a30\u0a32\u0a33\u0a35\u0a36\u0a38\u0a39\u0a3e-\u0a42\u0a47\u0a48\u0a4b\u0a4c\u0a51\u0a59-\u0a5c\u0a5e\u0a70-\u0a75\u0a81-\u0a83\u0a85-\u0a8d\u0a8f-\u0a91\u0a93-\u0aa8\u0aaa-\u0ab0\u0ab2\u0ab3\u0ab5-\u0ab9\u0abd-\u0ac5\u0ac7-\u0ac9\u0acb\u0acc\u0ad0\u0ae0-\u0ae3\u0af9\u0b01-\u0b03\u0b05-\u0b0c\u0b0f\u0b10\u0b13-\u0b28\u0b2a-\u0b30\u0b32\u0b33\u0b35-\u0b39\u0b3d-\u0b44\u0b47\u0b48\u0b4b\u0b4c\u0b56\u0b57\u0b5c\u0b5d\u0b5f-\u0b63\u0b71\u0b82\u0b83\u0b85-\u0b8a\u0b8e-\u0b90\u0b92-\u0b95\u0b99\u0b9a\u0b9c\u0b9e\u0b9f\u0ba3\u0ba4\u0ba8-\u0baa\u0bae-\u0bb9\u0bbe-\u0bc2\u0bc6-\u0bc8\u0bca-\u0bcc\u0bd0\u0bd7\u0c00-\u0c03\u0c05-\u0c0c\u0c0e-\u0c10\u0c12-\u0c28\u0c2a-\u0c39\u0c3d-\u0c44\u0c46-\u0c48\u0c4a-\u0c4c\u0c55\u0c56\u0c58-\u0c5a\u0c60-\u0c63\u0c81-\u0c83\u0c85-\u0c8c\u0c8e-\u0c90\u0c92-\u0ca8\u0caa-\u0cb3\u0cb5-\u0cb9\u0cbd-\u0cc4\u0cc6-\u0cc8\u0cca-\u0ccc\u0cd5\u0cd6\u0cde\u0ce0-\u0ce3\u0cf1\u0cf2\u0d01-\u0d03\u0d05-\u0d0c\u0d0e-\u0d10\u0d12-\u0d3a\u0d3d-\u0d44\u0d46-\u0d48\u0d4a-\u0d4c\u0d4e\u0d57\u0d5f-\u0d63\u0d7a-\u0d7f\u0d82\u0d83\u0d85-\u0d96\u0d9a-\u0db1\u0db3-\u0dbb\u0dbd\u0dc0-\u0dc6\u0dcf-\u0dd4\u0dd6\u0dd8-\u0ddf\u0df2\u0df3\u0e01-\u0e3a\u0e40-\u0e46\u0e4d\u0e81\u0e82\u0e84\u0e87\u0e88\u0e8a\u0e8d\u0e94-\u0e97\u0e99-\u0e9f\u0ea1-\u0ea3\u0ea5\u0ea7\u0eaa\u0eab\u0ead-\u0eb9\u0ebb-\u0ebd\u0ec0-\u0ec4\u0ec6\u0ecd\u0edc-\u0edf\u0f00\u0f40-\u0f47\u0f49-\u0f6c\u0f71-\u0f81\u0f88-\u0f97\u0f99-\u0fbc\u1000-\u1036\u1038\u103b-\u103f\u1050-\u1062\u1065-\u1068\u106e-\u1086\u108e\u109c\u109d\u10a0-\u10c5\u10c7\u10cd\u10d0-\u10fa\u10fc-\u1248\u124a-\u124d\u1250-\u1256\u1258\u125a-\u125d\u1260-\u1288\u128a-\u128d\u1290-\u12b0\u12b2-\u12b5\u12b8-\u12be\u12c0\u12c2-\u12c5\u12c8-\u12d6\u12d8-\u1310\u1312-\u1315\u1318-\u135a\u135f\u1380-\u138f\u13a0-\u13f5\u13f8-\u13fd\u1401-\u166c\u166f-\u167f\u1681-\u169a\u16a0-\u16ea\u16ee-\u16f8\u1700-\u170c\u170e-\u1713\u1720-\u1733\u1740-\u1753\u1760-\u176c\u176e-\u1770\u1772\u1773\u1780-\u17b3\u17b6-\u17c8\u17d7\u17dc\u1820-\u1877\u1880-\u18aa\u18b0-\u18f5\u1900-\u191e\u1920-\u192b\u1930-\u1938\u1950-\u196d\u1970-\u1974\u1980-\u19ab\u19b0-\u19c9\u1a00-\u1a1b\u1a20-\u1a5e\u1a61-\u1a74\u1aa7\u1b00-\u1b33\u1b35-\u1b43\u1b45-\u1b4b\u1b80-\u1ba9\u1bac-\u1baf\u1bba-\u1be5\u1be7-\u1bf1\u1c00-\u1c35\u1c4d-\u1c4f\u1c5a-\u1c7d\u1ce9-\u1cec\u1cee-\u1cf3\u1cf5\u1cf6\u1d00-\u1dbf\u1de7-\u1df4\u1e00-\u1f15\u1f18-\u1f1d\u1f20-\u1f45\u1f48-\u1f4d\u1f50-\u1f57\u1f59\u1f5b\u1f5d\u1f5f-\u1f7d\u1f80-\u1fb4\u1fb6-\u1fbc\u1fbe\u1fc2-\u1fc4\u1fc6-\u1fcc\u1fd0-\u1fd3\u1fd6-\u1fdb\u1fe0-\u1fec\u1ff2-\u1ff4\u1ff6-\u1ffc\u2071\u207f\u2090-\u209c\u2102\u2107\u210a-\u2113\u2115\u2119-\u211d\u2124\u2126\u2128\u212a-\u212d\u212f-\u2139\u213c-\u213f\u2145-\u2149\u214e\u2160-\u2188\u24b6-\u24e9\u2c00-\u2c2e\u2c30-\u2c5e\u2c60-\u2ce4\u2ceb-\u2cee\u2cf2\u2cf3\u2d00-\u2d25\u2d27\u2d2d\u2d30-\u2d67\u2d6f\u2d80-\u2d96\u2da0-\u2da6\u2da8-\u2dae\u2db0-\u2db6\u2db8-\u2dbe\u2dc0-\u2dc6\u2dc8-\u2dce\u2dd0-\u2dd6\u2dd8-\u2dde\u2de0-\u2dff\u2e2f\u3005-\u3007\u3021-\u3029\u3031-\u3035\u3038-\u303c\u3041-\u3096\u309d-\u309f\u30a1-\u30fa\u30fc-\u30ff\u3105-\u312d\u3131-\u318e\u31a0-\u31ba\u31f0-\u31ff\u3400-\u4db5\u4e00-\u9fd5\ua000-\ua48c\ua4d0-\ua4fd\ua500-\ua60c\ua610-\ua61f\ua62a\ua62b\ua640-\ua66e\ua674-\ua67b\ua67f-\ua6ef\ua717-\ua71f\ua722-\ua788\ua78b-\ua7ad\ua7b0-\ua7b7\ua7f7-\ua801\ua803-\ua805\ua807-\ua80a\ua80c-\ua827\ua840-\ua873\ua880-\ua8c3\ua8f2-\ua8f7\ua8fb\ua8fd\ua90a-\ua92a\ua930-\ua952\ua960-\ua97c\ua980-\ua9b2\ua9b4-\ua9bf\ua9cf\ua9e0-\ua9e4\ua9e6-\ua9ef\ua9fa-\ua9fe\uaa00-\uaa36\uaa40-\uaa4d\uaa60-\uaa76\uaa7a\uaa7e-\uaabe\uaac0\uaac2\uaadb-\uaadd\uaae0-\uaaef\uaaf2-\uaaf5\uab01-\uab06\uab09-\uab0e\uab11-\uab16\uab20-\uab26\uab28-\uab2e\uab30-\uab5a\uab5c-\uab65\uab70-\uabea\uac00-\ud7a3\ud7b0-\ud7c6\ud7cb-\ud7fb\uf900-\ufa6d\ufa70-\ufad9\ufb00-\ufb06\ufb13-\ufb17\ufb1d-\ufb28\ufb2a-\ufb36\ufb38-\ufb3c\ufb3e\ufb40\ufb41\ufb43\ufb44\ufb46-\ufbb1\ufbd3-\ufd3d\ufd50-\ufd8f\ufd92-\ufdc7\ufdf0-\ufdfb\ufe70-\ufe74\ufe76-\ufefc\uff21-\uff3a\uff41-\uff5a\uff66-\uffbe\uffc2-\uffc7\uffca-\uffcf\uffd2-\uffd7\uffda-\uffdc]|[0-9]|_|:/;function he(e,t){let r=e.findRenderNodeFromElement(t,(e=>e.postNode.isSection));return r&&r.postNode}function le(e){if(!e)throw new Error("expected marker to have render node")}function de(e,t,r){if(function(e){return e.isMarkerable}(e))return function(e,t,r=0){let s=0,i=e.markers.head;for(;i;){if(le(i.renderNode),i.renderNode.element===t)return s+r;if(i.isAtom){if(i.renderNode.headTextNode===t)return s;if(i.renderNode.tailTextNode===t)return s+1}s+=i.length,i=i.next}return s}(e,t,r);return function(e){T("findOffsetInSection must be called with markerable or card section",e&&e.isCardSection)}(e),le(e.renderNode),t===e.renderNode.element.lastChild?1:0}class ce{constructor(e,t=0,r=!1){r||(T("Position must have a section that is addressable by the cursor",e&&e.isLeafSection),T("Position must have numeric offset","number"===typeof t)),this.section=e,this.offset=t,this.isBlank=r}static atPoint(e,t,r){let{_renderTree:s,element:i}=r,n=document.elementFromPoint(e,t);if(!n||!b(i,n))return null;let{node:a,offset:o}=q(n,{left:e,top:t});return ce.fromNode(s,a,o)}static blankPosition(){return new ue}toRange(e=this,t=null){return new z(this,e,t)}get leafSectionIndex(){let e;return this.section.post.walkAllLeafSections(((t,r)=>{t===this.section&&(e=r)})),e}get isMarkerable(){return this.section&&this.section.isMarkerable}get marker(){return this.isMarkerable&&this.markerPosition.marker||null}markerIn(e){if(!this.isMarkerable)return;let{marker:t,offsetInMarker:r}=this;return t?r>0&&r<t.length?t:0===r?e===ae?t:t.prev:r===t.length?e===ne?t.next:t:void 0:void 0}get offsetInMarker(){return this.markerPosition.offset}isEqual(e){return this.section===e.section&&this.offset===e.offset}isHeadOfPost(){return this.move(ae).isEqual(this)}isTailOfPost(){return this.move(ne).isEqual(this)}isHead(){return this.isEqual(this.section.headPosition())}isTail(){return this.isEqual(this.section.tailPosition())}move(e){return T("Must pass integer to Position#move","number"===typeof e),e<0?this.moveLeft().move(++e):e>0?this.moveRight().move(--e):this}moveWord(e){if(e===ae?this.isHeadOfPost():this.isTailOfPost())return this;if(!this.isMarkerable)return this.move(e);let t=this,r=(e,t)=>t===ae?e.isHead():e.isTail(),s=e=>{let{marker:t,offsetInMarker:r}=e;return t.charAt(r)},i=(e,t)=>s(t===ae?e.move(ae):e),n=(e,t)=>!(t!==ae||!e.isTail()||!e.marker.isAtom)||(t===ae?e.move(ae).marker.isAtom:e.marker.isAtom);if(r(t,e))return t.move(e).moveWord(e);let a=t=>!r(t,e)&&!n(t,e)&&!oe.test(i(t,e));for(;a(t);)t=t.move(e);if(n(t,e))return t.move(e);let o=t=>!r(t,e)&&!n(t,e)&&oe.test(i(t,e));for(;o(t);)t=t.move(e);return t}moveLeft(){if(this.isHead()){let e=this.section.previousLeafSection();return e?e.tailPosition():this}{let e=this.offset-1;if(this.isMarkerable&&this.marker){let t=this.marker.value.charCodeAt(e);t>=P[0]&&t<=P[1]&&(e-=1)}return new ce(this.section,e)}}moveRight(){if(this.isTail()){let e=this.section.nextLeafSection();return e?e.headPosition():this}{let e=this.offset+1;if(this.isMarkerable&&this.marker){let t=this.marker.value.charCodeAt(e-1);t>=O[0]&&t<=O[1]&&(e+=1)}return new ce(this.section,e)}}static fromNode(e,t,r){return g(t)?ce.fromTextNode(e,t,r):C(t)?ce.fromElementNode(e,t,r):void T("Positions can only be created from text nodes or elements",!1)}static fromTextNode(e,t,r){const s=e.getElementRenderNode(t);let i,n;if(s){const e=s.postNode;i=e.section,T(`Could not find parent section for mapped text node "${t.textContent}"`,!!i),n=e.section.offsetOfMarker(e,r)}else i=he(e,t),T(`Could not find parent section for un-mapped text node "${t.textContent}"`,!!i),n=de(i,t,r);return new ce(i,n)}static fromElementNode(e,t,r=0){let s;if(t===e.rootElement){let t=e.rootNode.postNode;s=0===r?t.headPosition():t.tailPosition()}else{let i=he(e,t);if(T("Could not find parent section from element node",!!i),te(i))s=r<2?i.headPosition():i.tailPosition();else{let n=e.getElementRenderNode(t),a=n&&n.postNode;if(a&&ie(a)){let e=i.offsetOfMarker(a);r>1&&(e+=a.length),s=new ce(i,e)}else s=r>=t.childNodes.length?i.tailPosition():i.headPosition()}}return s}get markerPosition(){return T("Cannot get markerPosition without a section",!!this.section),L("cannot get markerPosition of a non-markerable",this.section,!!this.section.isMarkerable),this.section.markerPositionAtOffset(this.offset)}}class ue extends ce{constructor(){super(null,0,!0)}isEqual(e){return e&&e.isBlank}toRange(){return z.blankRange()}get leafSectionIndex(){throw new Error("must implement get leafSectionIndex")}get isMarkerable(){return!1}get marker(){return null}isHeadOfPost(){return!1}isTailOfPost(){return!1}isHead(){return!1}isTail(){return!1}move(){return this}moveWord(){return this}get markerPosition(){return{}}}const pe=(e,t,r)=>r(window.prompt(e,t));function me(e,t=pe){if(e.range.isCollapsed)return;let r=e.cursor.selectedText(),s="";-1!==r.indexOf("http")&&(s=r);let{range:i}=e;e.detectMarkupInRange(i,"a")?e.toggleMarkup("a"):t("Enter a URL",s,(t=>{t&&e.toggleMarkup("a",{href:t})}))}function fe(e,t,r=pe){r("Enter a URL",e.href,(r=>{if(!r)return;const s=ce.fromNode(t._renderTree,e.firstChild),i=new z(s,new ce(s.section,s.offset+e.textContent.length));t.run((e=>{let s=t.builder.createMarkup("a",{href:r});e.toggleMarkup(s,i),e.toggleMarkup(s,i)}))}))}var ke={toggleLink:me,editLink:fe};class ge extends class{constructor(e={}){this.isShowing=!1,this.isDestroyed=!1,e.tagName=e.tagName||"div",e.container=e.container||document.body,this.element=document.createElement(e.tagName),this.container=e.container,(e.classNames||[]).forEach((e=>E(this.element,e))),this._eventListeners=[]}addEventListener(e,t,r){e.addEventListener(t,r),this._eventListeners.push([e,t,r])}removeAllEventListeners(){this._eventListeners.forEach((([e,t,r])=>{e.removeEventListener(t,r)}))}show(){if(!this.isShowing)return this.container.appendChild(this.element),this.isShowing=!0,!0}hide(){if(this.isShowing)return this.container.removeChild(this.element),this.isShowing=!1,!0}destroy(){this.removeAllEventListeners(),this.hide(),this.isDestroyed=!0}}{constructor(e){super({...e,classNames:["__mobiledoc-tooltip"]}),this.elementObserver=null,this.rootElement=e.rootElement,this.editor=e.editor,this.addListeners(e)}showLink(e){const{editor:t,element:r}=this,{tooltipPlugin:s}=t;s.renderLink(r,e,{editLink:()=>{fe(e,t),this.hide()}}),this.show(),w(this.element,e),this.elementObserver=function(e,t){let r=!1;const s=()=>{r||(e.parentNode?window.requestAnimationFrame(s):t())};return s(),{cancel:()=>r=!0}}(e,(()=>this.hide()))}addListeners(e){const{rootElement:t,element:r}=this;let s,i;const n=()=>{clearTimeout(i),i=setTimeout((()=>{this.hide()}),600)};this.addEventListener(r,"mouseenter",(()=>{clearTimeout(i)})),this.addEventListener(r,"mouseleave",(()=>{n()})),this.addEventListener(t,"mouseover",(r=>{let n=function(e,t,r){for(e=A(e);t&&t!==r;){if(A(t.tagName)===e)return t;t=t.parentElement}}(e.showForTag,r.target,t);n&&n.isContentEditable&&(clearTimeout(i),s=setTimeout((()=>{n&&this.showLink(n)}),200))})),this.addEventListener(t,"mouseout",(()=>{clearTimeout(s),this.elementObserver&&this.elementObserver.cancel(),n()}))}}const _e={renderLink(e,t,{editLink:r}){const{href:s}=t;e.innerHTML=`<a href="${s}" target="_blank">${s}</a>`;const i=document.createElement("button");i.classList.add("__mobiledoc-tooltip__edit-link"),i.innerText="Edit Link",i.addEventListener("click",r),e.append(i)}};class Ce{constructor(e=[]){this.callbackQueues={},this.removalQueues={},e.forEach((e=>{this.callbackQueues[e]=[],this.removalQueues[e]=[]}))}runCallbacks(e,t=[]){let r=this._getQueue(e);r.forEach((e=>e(...t))),this.removalQueues[e].forEach((e=>{let t=r.indexOf(e);-1!==t&&r.splice(t,1)})),this.removalQueues[e]=[]}addCallback(e,t){this._getQueue(e).push(t)}_scheduleCallbackForRemoval(e,t){this.removalQueues[e].push(t)}addCallbackOnce(e,t){let r=this._getQueue(e);-1===r.indexOf(t)&&(r.push(t),this._scheduleCallbackForRemoval(e,t))}_getQueue(e){let t=this.callbackQueues[e];return T(`No queue found for "${e}"`,!!t),t}}function be(e){return"sections"in e}const Se="markerable",Ee="nested_markerable",Ae="non_markerable";class ye{constructor({postEditor:e,post:t},r){this.postEditor=e,this._post=t,this.cursorPosition=r,this.builder=this.postEditor.builder,this._hasInsertedFirstLeafSection=!1}get cursorPosition(){return this._cursorPosition}set cursorPosition(e){this._cursorPosition=e,this.postEditor.setRange(e)}visit(e){let t=e.type;L(`Cannot visit node of type ${e.type}`,0,t in this),this[t](e)}_canMergeSection(e){return!this._hasInsertedFirstLeafSection&&(this._isMarkerable&&e.isMarkerable)}get _isMarkerable(){return this.cursorSection.isMarkerable}get cursorSection(){return this.cursorPosition.section}get cursorOffset(){return this.cursorPosition.offset}get _isNested(){return this.cursorSection.isNested}post(e){let{cursorSection:t}=this;if(t.isBlank&&!t.isNested){let r=e.sections.map((e=>e.clone()));this._replaceSection(t,r)}else e.sections.forEach((e=>this.visit(e)))}"markup-section"(e){this.markerable(e)}"list-section"(e){let t=!!e.next;e.items.forEach((e=>this.visit(e))),this._isNested&&t&&this._breakNestedAtCursor()}"list-item"(e){this.nested_markerable(e)}"card-section"(e){this.non_markerable(e)}"image-section"(e){this.non_markerable(e)}[Ae](e){this._isNested?this._breakNestedAtCursor():this.cursorSection.isBlank||this._breakAtCursor(),this._insertLeafSection(e)}[Se](e){if(this._canMergeSection(e))this._mergeSection(e);else if(this._isNested&&this._isMarkerable){this._breakAtCursor();let t=this.cursorSection.next.headPosition();this.cursorPosition=t,this._mergeSection(e)}else this._breakAtCursor(),this._insertLeafSection(e)}[Ee](e){if(this._canMergeSection(e))return void this._mergeSection(e);let t=this._isNested?e:this._wrapNestedSection(e);this._breakAtCursor(),this._insertLeafSection(t)}_breakNestedAtCursor(){T("Cannot call _breakNestedAtCursor if not nested",this._isNested);let e=this.cursorSection.parent;if(this.cursorPosition.isEqual(e.tailPosition())){let t=this.builder.createMarkupSection();this._insertSectionAfter(t,e)}else{let[,e]=this._breakListAtCursor();this.cursorPosition=e.tailPosition()}}_breakListAtCursor(){T("Cannot _splitParentSection if cursor position is not nested",this._isNested);const e=this.cursorSection.parent,t=this.cursorPosition,r=this.builder.createMarkupSection();let[s,i]=this.postEditor._splitListAtPosition(e,t),n=this._post.sections,a=i;return this.postEditor.insertSectionBefore(n,r,a),[s,r,i]}_wrapNestedSection(e){let t=e.parent.tagName,r=this.builder.createListSection(t);return r.items.append(e.clone()),r}_mergeSection(e){T("Can only merge markerable sections",this._isMarkerable&&e.isMarkerable),this._hasInsertedFirstLeafSection=!0;let t=e.markers.map((e=>e.clone())),r=this.postEditor.insertMarkers(this.cursorPosition,t);this.cursorPosition=r}_breakAtCursor(){this.cursorSection.isBlank||(this._isMarkerable?this._breakMarkerableAtCursor():this._breakNonMarkerableAtCursor())}_breakNonMarkerableAtCursor(){const e=this._post.sections,t=this.builder.createMarkupSection(),r=this.cursorPosition.isHead()?this.cursorSection:this.cursorSection.next;this.postEditor.insertSectionBefore(e,t,r),this.cursorPosition=t.tailPosition()}_breakMarkerableAtCursor(){let[e]=this.postEditor.splitSection(this.cursorPosition);this.cursorPosition=e.tailPosition()}_replaceSection(e,t){T("Cannot replace section that does not have parent.sections",be(e.parent)),T("Must pass enumerable to _replaceSection",!!t.forEach);let r=e.parent.sections,s=e.next;this.postEditor.removeSection(e),t.forEach((e=>{this.postEditor.insertSectionBefore(r,e,s)}));let i=t[t.length-1];this.cursorPosition=i.tailPosition()}_insertSectionBefore(e,t){T("Cannot insert into section that does not have parent.sections",be(this.cursorSection.parent));let r=this.cursorSection.parent.sections;this.postEditor.insertSectionBefore(r,e,t),this.cursorPosition=e.tailPosition()}_insertSectionAfter(e,t){T("Cannot _insertSectionAfter nested section",!t.isNested);let r=t.next,s=this._post.sections;this.postEditor.insertSectionBefore(s,e,r),this.cursorPosition=e.tailPosition()}_insertLeafSection(e){if(T("Can only _insertLeafSection when cursor is at end of section",this.cursorPosition.isTail()),this._hasInsertedFirstLeafSection=!0,e=e.clone(),this.cursorSection.isBlank)T("Cannot insert leaf non-markerable section when cursor is nested",!(e.isMarkerable&&this._isNested)),this._replaceSection(this.cursorSection,[e]);else if(this.cursorSection.next&&this.cursorSection.next.isBlank)this._replaceSection(this.cursorSection.next,[e]);else{let t=this.cursorSection.next;this._insertSectionBefore(e,t)}}}class Me{constructor(e,t){this.postEditor=e,this.post=t}insert(e,t){let r=new ye(this,e);return t.isBlank||r.visit(t),r.cursorPosition}}function we(e,t=!1){t||console.log(`[mobiledoc-kit] [DEPRECATED]: ${e}`)}function ve(e){return T('Must pass non-blank object to "toRange"',!!e),e instanceof z?e:e instanceof ce?e.toRange():void T(`Incorrect structure for rangeLike: ${e}`,!1)}class Ne{constructor(e){this.editor=e,this.renderTree=e._renderTree,this.post=e.post}clearSelection(){!function(){const e=window.getSelection();e&&e.removeAllRanges()}()}hasCursor(){return this.editor.hasRendered&&(this._hasCollapsedSelection()||this._hasSelection())}hasSelection(){return this.editor.hasRendered&&this._hasSelection()}isAddressable(e){let{renderTree:t}=this,r=t.findRenderNodeFromElement(e);if(r&&r.postNode.isCardSection){let t=r.element;if(e!==t&&e!==t.firstChild&&e!==t.lastChild)return!1}return!!r}get offsets(){if(!this.hasCursor())return z.blankRange();let{renderTree:e}=this,t=D(this.editor.element),r=function(e,t){I("selection anchorNode should not be null",e.anchorNode),I("selection focusNode should not be null",e.focusNode);let{node:r,offset:s}=G(e.anchorNode,t,e.anchorOffset),{node:i,offset:n}=G(e.focusNode,t,e.focusOffset);return{anchorNode:r,anchorOffset:s,focusNode:i,focusOffset:n}}(this.selection,t);const{headNode:s,headOffset:i,tailNode:n,tailOffset:a,direction:o}=V(r),h=ce.fromNode(e,s,i),l=ce.fromNode(e,n,a);return new z(h,l,o)}_findNodeForPosition(e){let t,r,s=D(e.section);if(I("expected section to have render node",s.renderNode),te(s))r=0,t=0===e.offset?s.renderNode.element.firstChild:s.renderNode.element.lastChild;else if(s.isBlank||"image-section"===s.type)t=s.renderNode.cursorElement,r=0;else{let{marker:s,offsetInMarker:i}=e;I("expected position to have marker",s),I("expected marker to have render node",s.renderNode),s.isAtom?i>0?(r=0,t=s.renderNode.tailTextNode):(r=0,t=s.renderNode.headTextNode):(t=s.renderNode.element,r=i)}return{node:t,offset:r}}selectRange(e){if(e.isBlank)return void this.clearSelection();const{head:t,tail:r,direction:s}=e,{node:i,offset:n}=this._findNodeForPosition(t),{node:a,offset:o}=this._findNodeForPosition(r);this._moveToNode(i,n,a,o,s),this.editor._ensureFocus()}get selection(){return x(window.getSelection(),"expected window selection to not be null")}selectedText(){return this.selection.toString()}_moveToNode(e,t,r,s,i=$.FORWARD){this.clearSelection(),i===$.BACKWARD&&([e,t,r,s]=[r,s,e,t]);const n=document.createRange();n.setStart(e,t),i===$.BACKWARD&&this.selection instanceof Selection?(this.selection.addRange(n),this.selection.extend(r,s)):(n.setEnd(r,s),this.selection.addRange(n))}_hasSelection(){const e=D(this.editor.element),{_selectionRange:t}=this;return!(!t||t.collapsed)&&(b(e,D(this.selection.anchorNode))&&b(e,D(this.selection.focusNode)))}_hasCollapsedSelection(){const{_selectionRange:e}=this;if(!e)return!1;return b(D(this.editor.element),D(this.selection.anchorNode))}get _selectionRange(){const{selection:e}=this;return 0===e.rangeCount?null:e.getRangeAt(0)}}class Te{constructor(e=[]){this.items=[],e.forEach((e=>this.add(e)))}add(e){this.has(e)||this.items.push(e)}get length(){return this.items.length}has(e){return-1!==this.items.indexOf(e)}toArray(){return this.items}}class Re{constructor(e){if(this.head=null,this.tail=null,this.length=0,e){const{adoptItem:t,freeItem:r}=e;this._adoptItem=t,this._freeItem=r}}adoptItem(e){e.__parent=this,this.length++,this._adoptItem&&this._adoptItem(e)}freeItem(e){e.__parent=null,this.length--,this._freeItem&&this._freeItem(e)}get isEmpty(){return 0===this.length}prepend(e){this.insertBefore(e,this.head)}append(e){this.insertBefore(e,null)}insertAfter(e,t){let r=t?t.next:this.head;this.insertBefore(e,r)}_ensureItemIsNotAlreadyInList(e){T("Cannot insert an item into a list if it is already in a list",!e.next&&!e.prev&&this.head!==e)}insertBefore(e,t){let r;switch(this._ensureItemIsNotInList(e),this.adoptItem(e),r=t&&t.prev?"middle":t?"start":"end",r){case"start":this.head&&(e.next=this.head,this.head.prev=e),this.head=e;break;case"middle":{let r=t.prev;e.next=t,e.prev=r,t.prev=e,r.next=e;break}case"end":{let t=this.tail;e.prev=t,t?t.next=e:this.head=e,this.tail=e;break}}}remove(e){if(!Ie(e))return;this._ensureItemIsInThisList(e),this.freeItem(e);let[t,r]=[e.prev,e.next];e.prev=null,e.next=null,t?t.next=r:this.head=r,r?r.prev=t:this.tail=t}forEach(e){let t=this.head,r=0;for(;t;)e(t,r++),t=t.next}map(e){let t=[];return this.forEach((r=>t.push(e(r)))),t}walk(e,t,r){let s=e||this.head;for(;s&&(r(s),s!==t);)s=s.next}readRange(e,t){let r=[];return this.walk(e,t,(e=>{r.push(e)})),r}toArray(){return this.readRange()}detect(e,t=this.head,r=!1){for(;t;){if(e(t))return t;t=r?t.prev:t.next}}any(e){return!!this.detect(e)}every(e){let t=this.head;for(;t;){if(!e(t))return!1;t=t.next}return!0}objectAt(e){let t=-1;return this.detect((()=>(t++,e===t)))}splice(e,t,r){let s=e,i=s.next,n=0;for(;s&&n<t;)n++,i=s.next,this.remove(s),s=i;r.forEach((e=>{this.insertBefore(e,i)}))}removeBy(e){let t=this.head;for(;t;){let r=t.next;e(t)&&this.remove(t),t=r}}_ensureItemIsNotInList(e){T("Cannot insert an item into a list if it is already in a list",!e.__parent)}_ensureItemIsInThisList(e){T("Cannot remove item that is in another list",Ie(e)===this)}}function Ie(e){return e.__parent||null}function Le(e){return class extends e{constructor(){super(...arguments),this._tagName=null}set tagName(e){let t=A(e);T(`Cannot set section tagName to ${e}`,this.isValidTagName(t)),this._tagName=t}get tagName(){return this._tagName}}}class xe extends(Le(Z)){constructor(e,t,r=[]){super(e),this.type=e,this.isMarkerable=!0,this.tagName=t,this.markers=new Re({adoptItem:e=>{T(`Can only insert markers and atoms into markerable (was: ${e.type})`,e.isMarker||e.isAtom),e.section=e.parent=this},freeItem:e=>e.section=e.parent=null}),r.forEach((e=>this.markers.append(e)))}canJoin(e){return e.isMarkerable&&e.type===this.type&&e.tagName===this.tagName}clone(){const e=this.markers.map((e=>e.clone()));return this.builder.createMarkerableSection(this.type,this.tagName,e)}get isBlank(){return!this.markers.length||this.markers.every((e=>e.isBlank))}textUntil(e){T("Cannot get textUntil for a position not in this section",e.section===this);let{marker:t,offsetInMarker:r}=e,s="",i=this.markers.head;for(;i;){if(i===t){s+=i.textUntil(r);break}s+=i.text,i=i.next}return s}offsetOfMarker(e,t=0){T("Cannot get offsetOfMarker for marker that is not child of this",e.section===this);let r=0,s=this.markers.head;for(;s&&s!==e.next;){r+=s===e?t:s.length,s=s.next}return r}_redistributeMarkers(e,t,r,s=0){let i=e;return n(this.markers,(a=>{if(a===r){const[a,...o]=r.split(s);e.markers.append(a),n(o,(e=>t.markers.append(e))),i=t}else i.markers.append(a.clone())})),[e,t]}splitMarkerAtOffset(e){let t;T("Cannot splitMarkerAtOffset when offset is > length",e<=this.length);let r=0,s=this.markers.head,i={added:[],removed:[]};if(s)for(;s&&(r+=s.length,r!==e);){if(r>e){t=s.length-(r-e);let n=s.splitAtOffset(t);i.added.push(...n),i.removed.push(s),this.markers.splice(s,1,n);break}s=s.next}else{let e=this.builder.createMarker();this.markers.prepend(e),i.added.push(e)}return i}splitAtPosition(e){const{marker:t,offsetInMarker:r}=e;return this.splitAtMarker(t,r)}markerBeforeOffset(e){let t=0,r=this.markers.head;for(;r;){if(t+=r.length,t===e)return r;T("markerBeforeOffset called with sectionOffset not between markers",t<e),r=r.next}}markerPositionAtOffset(e){let t=0,r=null,s=e;return this.markers.detect((e=>(t=Math.min(s,e.length),s-=t,0===s&&(r=e,!0)))),{marker:r,offset:t}}get text(){return h(this.markers,((e,t)=>e+t.value),"")}get length(){return h(this.markers,((e,t)=>e+t.length),0)}markersFor(e,t){const r=z.create(this,e,this,t);let s=[];return this._markersInRange(r,((e,{markerHead:t,markerTail:r,isContained:i})=>{const n=e.clone();i||(n.value=e.value.slice(t,r)),s.push(n)})),s}markupsInRange(e){const t=new Te;return this._markersInRange(e,(e=>{e.markups.forEach((e=>t.add(e)))})),t.toArray()}_markersInRange(e,t){const{head:r,tail:s}=e;T("Cannot call #_markersInRange if range expands beyond this section",r.section===this&&s.section===this);const{offset:i}=r,{offset:n}=s;let a=0,o=0,h=this.markers.head;for(;h;){if(o+=h.length,o>i&&a<n){let e=Math.max(i-a,0),r=h.length-Math.max(o-n,0);t(h,{markerHead:e,markerTail:r,isContained:0===e&&r===h.length})}if(a+=h.length,h=h.next,a>n)break}}join(e){let t=this.markers.tail,r=null;return e.markers.forEach((e=>{e.isBlank||(e=e.clone(),this.markers.append(e),r||(r=e))})),{beforeMarker:t,afterMarker:r}}}function De(e){return e.isMarkerable}const Oe="markup-section",Pe="list-section",Be="list-item";function He(e){const t=Object.keys(e);let r=t.length;const s=new Array(r);for(;r--;)s[r]=[t[r],e[t[r]]];return s}const Fe=["data-md-text-align"];function $e(e){return class extends e{constructor(){super(...arguments),this.attributes={}}hasAttribute(e){return e in this.attributes}setAttribute(e,t){if(!u(Fe,e))throw new Error(`Invalid attribute "${e}" was passed. Constrain attributes to the spec-compliant whitelist.`);this.attributes[e]=t}removeAttribute(e){delete this.attributes[e]}getAttribute(e){return this.attributes[e]}eachAttribute(e){He(this.attributes).forEach((([t,r])=>e(t,r)))}}}const Ue=["ul","ol"].map(A),Ke=Ue[0];class We extends($e(Le(Z))){constructor(e=Ke,t=[],r={}){super(Pe),this.isListSection=!0,this.isLeafSection=!1,this.tagName=e,He(r).forEach((([e,t])=>this.setAttribute(e,t))),this.items=new Re({adoptItem:e=>{T(`Cannot insert non-list-item to list (is: ${e.type})`,e.isListItem),e.section=e._parent=this},freeItem:e=>e.section=e._parent=null}),this.sections=this.items,t.forEach((e=>this.items.append(e)))}canJoin(){return!1}isValidTagName(e){return u(Ue,e)}headPosition(){return this.items.head.headPosition()}tailPosition(){return this.items.tail.tailPosition()}get isBlank(){return this.items.isEmpty}clone(){let e=this.builder.createListSection(this.tagName);return n(this.items,(t=>e.items.append(t.clone()))),e}join(e){if(je(e))e.items.forEach((e=>this.join(e)));else if(e.isMarkerable){let t=this.builder.createListItem();t.join(e),this.items.append(t)}}}function je(e){return e.isListSection}const qe=["li"].map(A);class Ge extends xe{constructor(e,t=[]){super("list-item",e,t),this.isListItem=!0,this.isNested=!0,this.section=null}isValidTagName(e){return u(qe,e)}splitAtMarker(e,t=0){const r=!this.next,s=!e&&0===t&&r;let[i,n]=[this.builder.createListItem(),s?this.builder.createMarkupSection():this.builder.createListItem()];return this._redistributeMarkers(i,n,e,t)}get post(){return x(this.section,"expected list item to have section").post}}function Ve(e){return e.isListItem}const ze=["aside","blockquote","h1","h2","h3","h4","h5","h6","p"].map(A),Je=["aside","blockquote","h1","h2","h3","h4","h5","h6","p"].map(A),Qe=ze[8];class Ye extends($e(xe)){constructor(e=Qe,t=[],r={}){super(Oe,e,t),this.isMarkupSection=!0,this.isGenerated=!1,this._inferredTagName=!1,He(r).forEach((([e,t])=>this.setAttribute(e,t)))}isValidTagName(e){return u(ze,e)}splitAtMarker(e,t=0){let[r,s]=[this.builder.createMarkupSection(this.tagName,[],!1,this.attributes),this.builder.createMarkupSection()];return this._redistributeMarkers(r,s,e,t)}}function Ze(e){return e.isMarkupSection}function Xe(e){return Ze(e)&&e._inferredTagName}const{FORWARD:et,BACKWARD:tt}=$;const rt={BEFORE_COMPLETE:"beforeComplete",COMPLETE:"complete",AFTER_COMPLETE:"afterComplete"};class st{constructor(e){this.editor=e,this.builder=this.editor.builder,this._callbacks=new Ce(p(rt)),this._didComplete=!1,this.editActionTaken=null,this._renderRange=()=>this.editor.selectRange(this._range),this._postDidChange=()=>this.editor._postDidChange(),this._rerender=()=>this.editor.rerender()}addCallback(e,t){this._callbacks.addCallback(e,t)}addCallbackOnce(e,t){this._callbacks.addCallbackOnce(e,t)}runCallbacks(e){this._callbacks.runCallbacks(e)}begin(){this._range=this.editor.range}setRange(e){e=ve(e),this._range=e,this.scheduleAfterRender(this._renderRange,!0)}deleteRange(e){T("Must pass MobiledocKit Range to `deleteRange`",e instanceof z),this.editActionTaken=2;const{head:t,tail:r}=e;let s=t.section,i=r.section;const{editor:n}=this,{post:a}=n;if(s===i)return this.cutSection(s,t,r);let o=s.nextLeafSection(),h=this.cutSection(s,t,s.tailPosition());for(s=h.section;o!==i;){let e=o;o=o.nextLeafSection(),this.removeSection(e)}let l=this.cutSection(i,i.headPosition(),r);return i=l.section,i.isBlank?this.removeSection(i):De(s)&&De(i)?(s.join(i),this._markDirty(s),this.removeSection(i)):s.isBlank&&(this.removeSection(s),h=l),a.isBlank&&(a.sections.append(this.builder.createMarkupSection("p")),h=a.headPosition()),h}cutSection(e,t,r){if(T("Must pass head position and tail position to `cutSection`",t instanceof ce&&r instanceof ce),T("Must pass positions within same section to `cutSection`",t.section===r.section),e.isBlank||t.isEqual(r))return t;if(e.isCardSection){if(t.isHead()&&r.isTail()){let t=this.builder.createMarkupSection();return this.replaceSection(e,t),t.headPosition()}return r}let s=t.toRange(r);return this.splitMarkers(s).forEach((e=>this.removeMarker(e))),t}_coalesceMarkers(e){De(e)&&(this._removeBlankMarkers(e),this._joinSimilarMarkers(e))}_removeBlankMarkers(e){n(a(e.markers,(e=>e.isBlank)),(e=>this.removeMarker(e)))}_joinSimilarMarkers(e){let t,r=e.markers.head;for(;r&&r.next;)t=r.next,r.canJoin(t)&&(t.value=r.value+t.value,this._markDirty(t),this.removeMarker(r)),r=t}removeMarker(e){this._scheduleForRemoval(e),e.section&&(this._markDirty(e.section),e.section.markers.remove(e))}_scheduleForRemoval(e){e.renderNode&&(e.renderNode.scheduleForRemoval(),this.scheduleRerender(),this.scheduleDidUpdate()),(e.prev&&je(e.prev)||e.next&&je(e.next))&&this.addCallback(rt.BEFORE_COMPLETE,(()=>this._joinContiguousListSections()))}_joinContiguousListSections(){let e,t,{post:r}=this.editor,s=this._range,i=[],a=null;n(r.sections,(r=>{e&&je(e)&&je(r)&&e.tagName===r.tagName?(t=t||[e],t.push(r)):(t&&i.push(t),t=null),e=r})),t&&i.push(t),n(i,(e=>{let t=e[0];n(e,(e=>{if(e===t)return;let r,i=s.head;!s.isBlank&&Ve(i.section)&&i.section.parent===e&&(r=t.tailPosition()),this._joinListSections(t,e),r&&(a=r.move(et))}))})),a&&this.setRange(a)}_joinListSections(e,t){e.join(t),this._markDirty(e),this.removeSection(t)}_markDirty(e){e.renderNode&&(e.renderNode.markDirty(),this.scheduleRerender(),this.scheduleDidUpdate()),"section"in e&&e.section&&this._markDirty(e.section),De(e)&&this.addCallback(rt.BEFORE_COMPLETE,(()=>this._coalesceMarkers(e)))}deleteFrom(e,t=$.BACKWARD){return we("`postEditor#deleteFrom is deprecated. Use `deleteAtPosition(position, direction=BACKWARD, {unit}={unit: 'char'})` instead"),this.deleteAtPosition(e,t,{unit:Gs.CHAR})}deleteAtPosition(e,t=$.BACKWARD,{unit:r}={unit:Gs.CHAR}){return t===$.BACKWARD?this._deleteAtPositionBackward(e,r):this._deleteAtPositionForward(e,r)}_deleteAtPositionBackward(e,t){if(e.isHead()&&Ve(e.section))return this.toggleSection("p",e),this._range.head;{let r=("word"===t?e.moveWord(tt):e.move(tt)).toRange(e);return this.deleteRange(r)}}_deleteAtPositionForward(e,t){let r="word"===t?e.moveWord(et):e.move(et),s=e.toRange(r);return this.deleteRange(s)}splitMarkers(e){const{post:t}=this.editor,{head:r,tail:s}=e;return this.splitSectionMarkerAtOffset(r.section,r.offset),this.splitSectionMarkerAtOffset(s.section,s.offset),t.markersContainedByRange(e)}splitSectionMarkerAtOffset(e,t){e.splitMarkerAtOffset(t).removed.forEach((e=>this.removeMarker(e)))}splitSection(e){const t=e.section;if(te(t))return this._splitCardSection(t,e);if(Ve(t)){if(t.isBlank&&!t.next){let e=t.parent,r=this.editor.post.sections,s=this.builder.createMarkupSection();return this.removeSection(t),this.insertSectionBefore(r,s,e.next),[null,s]}{let[r,s]=this._splitListItem(t,e);return[r,s]}}{let r=t.splitAtPosition(e);return r.forEach((e=>this._coalesceMarkers(e))),this._replaceSection(t,r),r}}_splitCardSection(e,t){let{offset:r}=t;T("Cards section must be split at offset 0 or 1",0===r||1===r);let s,i,n=this.builder.createMarkupSection();0===r?(s=e,i=[n,e]):(s=e.next,i=[e,n]);let a=this.editor.post.sections;return this.insertSectionBefore(a,n,s),i}replaceSection(e,t){e?this._replaceSection(e,[t]):this.insertSectionBefore(this.editor.post.sections,t,null)}moveSectionBefore(e,t,r){const s=t.clone();return this.removeSection(t),this.insertSectionBefore(e,s,r),s}moveSectionUp(e){if(!e.prev)return e;const t=e.parent.sections,r=e.prev;return this.moveSectionBefore(t,e,r)}moveSectionDown(e){if(!e.next)return e;const t=e.next.next,r=e.parent.sections;return this.moveSectionBefore(r,e,t)}insertMarkers(e,t){const r=e.section;let s=e.offset;T("Cannot insert markers at non-markerable position",r.isMarkerable),this.editActionTaken=1,r.splitMarkerAtOffset(s).removed.forEach((e=>this._scheduleForRemoval(e)));let i=r.markerBeforeOffset(s);t.forEach((e=>{r.markers.insertAfter(e,i),s+=e.length,i=e})),this._coalesceMarkers(r),this._markDirty(r);let n=r.toPosition(s);return this.setRange(n),n}insertTextWithMarkup(e,t,r=[]){let{section:s}=e;if(!s.isMarkerable)return;let i=this.builder.createMarker(t,r);return this.insertMarkers(e,[i])}insertText(e,t){let{section:r}=e;if(!r.isMarkerable)return;let s=e.marker&&e.marker.markups;return s=s||[],this.insertTextWithMarkup(e,t,s)}_replaceSection(e,t){let r=e.next,s=e.parent.sections;Ze(t[0])&&Ve(e)&&(s=e.parent.parent.sections,r=e.parent.next),t.forEach((e=>this.insertSectionBefore(s,e,r))),this.removeSection(e)}addMarkupToRange(e,t){if(e.isCollapsed)return;let r=this.splitMarkers(e);if(r.length){let e=h(r,(function(e,t){return function(e,t){let r=0;for(;r<e.length&&r<t.length&&e[r]===t[r];)r++;return e.slice(0,r)}(e,t.markups)}),r[0].markups).length;r.forEach((r=>{r.addMarkupAtIndex(t,e),this._markDirty(r)}))}}removeMarkupFromRange(e,t){e.isCollapsed||this.splitMarkers(e).forEach((e=>{e.removeMarkup(t),this._markDirty(e)}))}toggleMarkup(e,t=this._range){t=ve(t);const r="string"===typeof e?this.builder.createMarkup(e):e,s=this.editor.detectMarkupInRange(t,r.tagName);s?this.removeMarkupFromRange(t,s):this.addMarkupToRange(t,r),this.setRange(t)}toggleSection(e,t=this._range){t=function(e){const{head:t,tail:r}=e;return 0===r.offset&&t.section!==r.section&&(e.tail=new ce(r.section.prev,r.section.prev.length)),e}(ve(t)),e=A(e);let{post:r}=this.editor,s=!0;r.walkMarkerableSections(t,(t=>{this._isSameSectionType(t,e)||(s=!1)}));let i=s?"p":e,n=[];r.walkMarkerableSections(t,(e=>{let t=this.changeSectionTagName(e,i);n.push({from:e,to:t})}));let a=this._determineNextRangeAfterToggleSection(t,n);this.setRange(a)}_determineNextRangeAfterToggleSection(e,t){if(t.length){let r=s(t,(({from:t})=>t===e.headSection)).to,i=s(t,(({from:t})=>t===e.tailSection)).to;return r.isListSection||i.isListSection?t[0].to.headPosition().toRange():z.create(r,e.headSectionOffset,i,e.tailSectionOffset,e.direction)}return e}setAttribute(e,t,r=this._range){this._mutateAttribute(e,r,((e,r)=>{if(e.getAttribute(r)!==t)return e.setAttribute(r,t),!0}))}removeAttribute(e,t=this._range){this._mutateAttribute(e,t,((e,t)=>{if(e.hasAttribute(t))return e.removeAttribute(t),!0}))}_mutateAttribute(e,t,r){t=ve(t);let{post:s}=this.editor,i=`data-md-${e}`;s.walkMarkerableSections(t,(e=>{const t=Ve(e)?e.parent:e;!0===r(t,i)&&this._markDirty(e)})),this.setRange(t)}_isSameSectionType(e,t){return Ve(e)?e.parent.tagName===t:e.tagName===t}changeSectionTagName(e,t){return T("Cannot pass non-markerable section to `changeSectionTagName`",e.isMarkerable),"ul"===(r=t)||"ol"===r?this._changeSectionToListItem(e,t):Ve(e)?this._changeSectionFromListItem(e,t):(e.tagName=t,this._markDirty(e),e);var r}_splitListItem(e,t){let{section:r,offset:s}=t;T("Cannot split list item at position that does not include item",e===r),e.splitMarkerAtOffset(s);let i=e.markerBeforeOffset(s),n=this.builder.createListItem(),a=this.builder.createListItem(),o=n;return e.markers.forEach((e=>{o.markers.append(e.clone()),e===i&&(o=a)})),this._replaceSection(e,[n,a]),[n,a]}_splitListAtPosition(e,t){if(T("Cannot split list at position not in list",t.section.parent===e),!t.isHead()&&!t.isTail()){let e=t.section,[r]=this._splitListItem(e,t);t=r.tailPosition()}let r=this.builder.createListSection(e.tagName),s=this.builder.createListSection(e.tagName),i=t.section,n=r;return e.items.forEach((e=>{e===i&&t.isEqual(e.headPosition())&&(n=s),n.items.append(e.clone()),e===i&&(n=s)})),this._replaceSection(e,[r,s]),[r,s]}_splitListAtItem(e,t){let r=e,s=this.builder.createListSection(r.tagName,[],r.attributes),i=this.builder.createListSection(r.tagName),n=!0;r.items.toArray().forEach((e=>{let r;if(e===t)n=!1,r=i;else{if(!n)return;r=s}r.join(e),this.removeSection(e)})),T("Cannot split list at item that is not present in the list",!n);let a=this.editor.post.sections;return this.insertSectionBefore(a,i,r),this.insertSectionBefore(a,s,i),this.addCallback(rt.BEFORE_COMPLETE,(()=>{[s,r].forEach((e=>{let t=!!e._parent;e.isBlank&&t&&this.removeSection(e)}))})),[s,i,r]}_changeSectionFromListItem(e,t){L("Must pass list item to `_changeSectionFromListItem`",0,Ve(e));let r=e.parent,s=this.builder.createMarkupSection(t);s.join(e);let[,i]=this._splitListAtItem(r,e);return this.replaceSection(i,s),s}_changeSectionToListItem(e,t){if(e.isListItem&&e.parent.tagName===t)return e;let r,s=this.builder.createListSection(t);if(s.join(e),Ve(e)){let[,t]=this._splitListAtItem(e.parent,e);r=t}else r=e;return this.replaceSection(r,s),s}insertSectionBefore(e,t,r){e.insertBefore(t,r),this._markDirty(t.parent)}insertSection(e){const t=this.editor.activeSection,r=t&&t.next,s=this.editor.post.sections;this.insertSectionBefore(s,e,r)}insertSectionAtEnd(e){this.insertSectionBefore(this.editor.post.sections,e,null)}insertPost(e,t){let r=this.editor.post;return new Me(this,r).insert(e,t)}removeSection(e){let t=e.parent;L("expected section to have child sections",0,be(t)),this._scheduleForRemoval(e),t.sections.remove(e),je(t)&&this._scheduleListRemovalIfEmpty(t)}removeAllSections(){this.editor.post.sections.toArray().forEach((e=>{this.removeSection(e)}))}migrateSectionsFromPost(e){e.sections.toArray().forEach((t=>{e.sections.remove(t),this.insertSectionBefore(this.editor.post.sections,t,null)}))}_scheduleListRemovalIfEmpty(e){this.addCallback(rt.BEFORE_COMPLETE,(()=>{!!e._parent&&e.isBlank&&this.removeSection(e)}))}schedule(e,t=!1){T("Work can only be scheduled before a post edit has completed",!this._didComplete),t?this.addCallbackOnce(rt.COMPLETE,e):this.addCallback(rt.COMPLETE,e)}scheduleOnce(e){this.schedule(e,!0)}scheduleRerender(){this.scheduleOnce(this._rerender)}scheduleDidUpdate(){this.scheduleOnce(this._postDidChange)}scheduleAfterRender(e,t=!1){t?this.addCallbackOnce(rt.AFTER_COMPLETE,e):this.addCallback(rt.AFTER_COMPLETE,e)}complete(){T("Post editing can only be completed once",!this._didComplete),this.runCallbacks(rt.BEFORE_COMPLETE),this._didComplete=!0,this.runCallbacks(rt.COMPLETE),this.runCallbacks(rt.AFTER_COMPLETE)}undoLastChange(){this.editor._editHistory.stepBackward(this)}redoLastChange(){this.editor._editHistory.stepForward(this)}cancelSnapshot(){this._shouldCancelSnapshot=!0}}var it={name:"image",type:"dom",render({payload:e}){let t=document.createElement("img");return t.src=e.src||"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJbSJIAAAAMFBMVEXp7vG6vsHm6+63u77Hy868wMPe4+bO09bh5unr8fTR1djAxMfM0NPX3N/c4eTBxcjXRf5TAAACh0lEQVR4nO3b6ZKqMBSFUSQMYZL3f9tbBq/NEEDiqUqOfusn1ZXKbjcQlGQZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACC6RkbsGHuabChEtHmiGYfS3EQYM+Sxw/gMQvmcNnYaj6oTDHi73WPn2eqnj9B8zo3TJXcq5uNjXmVff86VwSR3JtryMa1BYqi7S1hJDCVpSigyLcGhJJEwzlCSNtPKrbVhVwsdCfOhH7uuaG3ARV9DwsaOzxt3N1yPqCHhvXytTUz92VDpmE/LLhZwl++R6Sds6sUa/PL6K/2E2fIhw1xdRKefsFolrPc+xNx/N0k/4fpBsdhL2HfeiN+TsDCms8dDpeRyS3P3QDl6Iqaf8L0rTf+80m6Lmn7Ct+4Wxf+/2RY1/YRv3PHz/u+fsCmqgoTnq7Z+8SGviqoh4dnKu1ieqauiakh4/PQ0r6ivqDoSHj0B97eNRVG1JNxV+L4bnxdVecJtRTdFVZ7QU9F1UXUn9FZ0VVRlCav5ob2KLouqKmFjy676u2HsVnRRVFUJq3J+8KCi86IqSthMvyl209Hjijqm3RsqAZ5pNfa5PJ2KelJRjQmr1/r7cfy0ouoSNvOfvbvhvKLaEr4qOin9kTQnrN7LpDZhE/Zmhp6Eq4p+YcKgiipKGFhRRQkDK6ooYfgLbiSMioQkJGF8P5XwHv4O+7AaKiXzaeXh1kMl5AffTUxiKEm/krD94BR8Gdxl1fceSlR58ZhXKbEpyD2amNiBtmrJLTMHL1LF8/rpXkSZXEmz8K8uvAFFNm6Iq0aBLUFOmeCuJ6exrcCmoLpN7kYx891bSAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgh/wDdr8peyRHLogAAAAASUVORK5CYII=",t}};class nt{constructor(e){this.builder=e}parse({sections:e}){try{const t=e[0],r=e[1],s=this.builder.createPost();return this.markups=[],this.markerTypes=this.parseMarkerTypes(t),this.parseSections(r,s),s}catch(t){T(`Unable to parse mobiledoc: ${t.message}`,!1)}}parseMarkerTypes(e){return e.map((e=>this.parseMarkerType(e)))}parseMarkerType([e,t]){const r=l(t||[]);return this.builder.createMarkup(e,r)}parseSections(e,t){e.forEach((e=>this.parseSection(e,t)))}parseSection(e,t){switch(e[0]){case 1:this.parseMarkupSection(e,t);break;case 2:this.parseImageSection(e,t);break;case 10:this.parseCardSection(e,t);break;case 3:this.parseListSection(e,t);break;default:T(`Unexpected section type ${e[0]}`,!1)}}parseCardSection([,e,t],r){const s=this.builder.createCardSection(e,t);r.sections.append(s)}parseImageSection([,e],t){const r=this.builder.createImageSection(e);t.sections.append(r)}parseMarkupSection([,e,t],r){const s=this.builder.createMarkupSection("pull-quote"===e.toLowerCase()?"aside":e);r.sections.append(s),this.parseMarkers(t,s),a(s.markers,(e=>e.isBlank)).forEach((e=>{s.markers.remove(e)}))}parseListSection([,e,t],r){const s=this.builder.createListSection(e);r.sections.append(s),this.parseListItems(t,s)}parseListItems(e,t){e.forEach((e=>this.parseListItem(e,t)))}parseListItem(e,t){const r=this.builder.createListItem();this.parseMarkers(e,r),t.items.append(r)}parseMarkers(e,t){e.forEach((e=>this.parseMarker(e,t)))}parseMarker([e,t,r],s){e.forEach((e=>{this.markups.push(this.markerTypes[e])}));const i=this.builder.createMarker(r,this.markups.slice());s.markers.append(i),this.markups=this.markups.slice(0,this.markups.length-t)}}class at{constructor(e){this.builder=e}parse({sections:e,markups:t,cards:r,atoms:s}){try{const i=this.builder.createPost();return this.markups=[],this.markerTypes=this.parseMarkerTypes(t),this.cardTypes=this.parseCardTypes(r),this.atomTypes=this.parseAtomTypes(s),this.parseSections(e,i),i}catch(i){T(`Unable to parse mobiledoc: ${i.message}`,!1)}}parseMarkerTypes(e){return e.map((e=>this.parseMarkerType(e)))}parseMarkerType([e,t]){const r=l(t||[]);return this.builder.createMarkup(e,r)}parseCardTypes(e){return e.map((e=>this.parseCardType(e)))}parseCardType([e,t]){return[e,t]}parseAtomTypes(e){return e.map((e=>this.parseAtomType(e)))}parseAtomType([e,t,r]){return[e,t,r]}parseSections(e,t){e.forEach((e=>this.parseSection(e,t)))}parseSection(e,t){switch(e[0]){case 1:this.parseMarkupSection(e,t);break;case 2:this.parseImageSection(e,t);break;case 10:this.parseCardSection(e,t);break;case 3:this.parseListSection(e,t);break;default:T(`Unexpected section type ${e[0]}`,!1)}}getAtomTypeFromIndex(e){const t=this.atomTypes[e];return T(`No atom definition found at index ${e}`,!!t),t}getCardTypeFromIndex(e){const t=this.cardTypes[e];return T(`No card definition found at index ${e}`,!!t),t}parseCardSection([,e],t){const[r,s]=this.getCardTypeFromIndex(e),i=this.builder.createCardSection(r,s);t.sections.append(i)}parseImageSection([,e],t){const r=this.builder.createImageSection(e);t.sections.append(r)}parseMarkupSection([,e,t],r){const s=this.builder.createMarkupSection("pull-quote"===e.toLowerCase()?"aside":e);r.sections.append(s),this.parseMarkers(t,s),a(s.markers,(e=>e.isBlank)).forEach((e=>{s.markers.remove(e)}))}parseListSection([,e,t],r){const s=this.builder.createListSection(e);r.sections.append(s),this.parseListItems(t,s)}parseListItems(e,t){e.forEach((e=>this.parseListItem(e,t)))}parseListItem(e,t){const r=this.builder.createListItem();this.parseMarkers(e,r),t.items.append(r)}parseMarkers(e,t){e.forEach((e=>this.parseMarker(e,t)))}parseMarker([e,t,r,s],i){t.forEach((e=>{this.markups.push(this.markerTypes[e])}));const n=this.buildMarkerType(e,s);i.markers.append(n),this.markups=this.markups.slice(0,this.markups.length-r)}buildMarkerType(e,t){switch(e){case 0:return this.builder.createMarker(t,this.markups.slice());case 1:{const[e,r,s]=this.getAtomTypeFromIndex(t);return this.builder.createAtom(e,r,s,this.markups.slice())}default:T(`Unexpected marker type ${e}`,!1)}}}class ot{constructor(e){this.builder=e}parse({sections:e,markups:t,cards:r,atoms:s}){try{const i=this.builder.createPost();return this.markups=[],this.markerTypes=this.parseMarkerTypes(t),this.cardTypes=this.parseCardTypes(r),this.atomTypes=this.parseAtomTypes(s),this.parseSections(e,i),i}catch(i){T(`Unable to parse mobiledoc: ${i.message}`,!1)}}parseMarkerTypes(e){return e.map((e=>this.parseMarkerType(e)))}parseMarkerType([e,t]){const r=l(t||[]);return this.builder.createMarkup(e,r)}parseCardTypes(e){return e.map((e=>this.parseCardType(e)))}parseCardType([e,t]){return[e,t]}parseAtomTypes(e){return e.map((e=>this.parseAtomType(e)))}parseAtomType([e,t,r]){return[e,t,r]}parseSections(e,t){e.forEach((e=>this.parseSection(e,t)))}parseSection(e,t){switch(e[0]){case 1:this.parseMarkupSection(e,t);break;case 2:this.parseImageSection(e,t);break;case 10:this.parseCardSection(e,t);break;case 3:this.parseListSection(e,t);break;default:T(`Unexpected section type ${e[0]}`,!1)}}getAtomTypeFromIndex(e){const t=this.atomTypes[e];return T(`No atom definition found at index ${e}`,!!t),t}getCardTypeFromIndex(e){const t=this.cardTypes[e];return T(`No card definition found at index ${e}`,!!t),t}parseCardSection([,e],t){const[r,s]=this.getCardTypeFromIndex(e),i=this.builder.createCardSection(r,s);t.sections.append(i)}parseImageSection([,e],t){const r=this.builder.createImageSection(e);t.sections.append(r)}parseMarkupSection([,e,t],r){const s=this.builder.createMarkupSection(e);r.sections.append(s),this.parseMarkers(t,s),a(s.markers,(e=>e.isBlank)).forEach((e=>{s.markers.remove(e)}))}parseListSection([,e,t],r){const s=this.builder.createListSection(e);r.sections.append(s),this.parseListItems(t,s)}parseListItems(e,t){e.forEach((e=>this.parseListItem(e,t)))}parseListItem(e,t){const r=this.builder.createListItem();this.parseMarkers(e,r),t.items.append(r)}parseMarkers(e,t){e.forEach((e=>this.parseMarker(e,t)))}parseMarker([e,t,r,s],i){t.forEach((e=>{this.markups.push(this.markerTypes[e])}));const n=this.buildMarkerType(e,s);i.markers.append(n),this.markups=this.markups.slice(0,this.markups.length-r)}buildMarkerType(e,t){switch(e){case 0:return this.builder.createMarker(t,this.markups.slice());case 1:{const[e,r,s]=this.getAtomTypeFromIndex(t);return this.builder.createAtom(e,r,s,this.markups.slice())}default:T(`Unexpected marker type ${e}`,!1)}}}class ht{constructor(e){this.builder=e}parse({sections:e,markups:t,cards:r,atoms:s}){try{const i=this.builder.createPost();return this.markups=[],this.markerTypes=this.parseMarkerTypes(t),this.cardTypes=this.parseCardTypes(r),this.atomTypes=this.parseAtomTypes(s),this.parseSections(e,i),i}catch(i){T(`Unable to parse mobiledoc: ${i.message}`,!1)}}parseMarkerTypes(e){return e.map((e=>this.parseMarkerType(e)))}parseMarkerType([e,t]){const r=l(t||[]);return this.builder.createMarkup(e,r)}parseCardTypes(e){return e.map((e=>this.parseCardType(e)))}parseCardType([e,t]){return[e,t]}parseAtomTypes(e){return e.map((e=>this.parseAtomType(e)))}parseAtomType([e,t,r]){return[e,t,r]}parseSections(e,t){e.forEach((e=>this.parseSection(e,t)))}parseSection(e,t){switch(e[0]){case 1:this.parseMarkupSection(e,t);break;case 2:this.parseImageSection(e,t);break;case 10:this.parseCardSection(e,t);break;case 3:this.parseListSection(e,t);break;default:T(`Unexpected section type ${e[0]}`,!1)}}getAtomTypeFromIndex(e){const t=this.atomTypes[e];return T(`No atom definition found at index ${e}`,!!t),t}getCardTypeFromIndex(e){const t=this.cardTypes[e];return T(`No card definition found at index ${e}`,!!t),t}parseCardSection([,e],t){const[r,s]=this.getCardTypeFromIndex(e),i=this.builder.createCardSection(r,s);t.sections.append(i)}parseImageSection([,e],t){const r=this.builder.createImageSection(e);t.sections.append(r)}parseMarkupSection([,e,t,r],s){const i=this.builder.createMarkupSection(e);s.sections.append(i),r&&He(l(r)).forEach((([e,t])=>{i.setAttribute(e,t)})),this.parseMarkers(t,i),a(i.markers,(e=>e.isBlank)).forEach((e=>{i.markers.remove(e)}))}parseListSection([,e,t,r],s){const i=this.builder.createListSection(e);s.sections.append(i),r&&He(l(r)).forEach((([e,t])=>{i.setAttribute(e,t)})),this.parseListItems(t,i)}parseListItems(e,t){e.forEach((e=>this.parseListItem(e,t)))}parseListItem(e,t){const r=this.builder.createListItem();this.parseMarkers(e,r),t.items.append(r)}parseMarkers(e,t){e.forEach((e=>this.parseMarker(e,t)))}parseMarker([e,t,r,s],i){t.forEach((e=>{this.markups.push(this.markerTypes[e])}));const n=this.buildMarkerType(e,s);i.markers.append(n),this.markups=this.markups.slice(0,this.markups.length-r)}buildMarkerType(e,t){switch(e){case 0:return this.builder.createMarker(t,this.markups.slice());case 1:{const[e,r,s]=this.getAtomTypeFromIndex(t);return this.builder.createAtom(e,r,s,this.markups.slice())}default:T(`Unexpected marker type ${e}`,!1)}}}function lt(e,t,r){const s=t.type;R(`Cannot visit unknown type ${s}`,s,e),e[s](t,r)}function dt(e,t){for(let r=0,s=t.length;r<s;r++){let[s,...i]=t[r];e[s].apply(e,i)}}function ct(e,t,r){t&&0!==t.length&&n(t,(t=>{lt(e,t,r)}))}const ut="0.2.0",pt={post(e,t){t.push(["openPost"]),ct(pt,e.sections,t)},"markup-section"(e,t){t.push(["openMarkupSection",e.tagName]),ct(pt,e.markers,t)},"list-section"(e,t){t.push(["openListSection",e.tagName]),ct(pt,e.items,t)},"list-item"(e,t){t.push(["openListItem"]),ct(pt,e.markers,t)},"image-section"(e,t){t.push(["openImageSection",e.src])},"card-section"(e,t){t.push(["openCardSection",e.name,e.payload])},marker(e,t){t.push(["openMarker",e.closedMarkups.length,e.value]),ct(pt,e.openedMarkups,t)},markup(e,t){t.push(["openMarkup",e.tagName,d(e.attributes)])}};class mt{openMarker(e,t){this.markupMarkerIds=[],this.markers.push([this.markupMarkerIds,e,t||""])}openMarkupSection(e){this.markers=[],this.sections.push([1,e,this.markers])}openListSection(e){this.items=[],this.sections.push([3,e,this.items])}openListItem(){this.markers=[],this.items.push(this.markers)}openImageSection(e){this.sections.push([2,e])}openCardSection(e,t){this.sections.push([10,e,t])}openPost(){this.markerTypes=[],this.sections=[],this.result={version:ut,sections:[this.markerTypes,this.sections]}}openMarkup(e,t){const r=this._findOrAddMarkerTypeIndex(e,t);this.markupMarkerIds.push(r)}_findOrAddMarkerTypeIndex(e,t){this._markerTypeCache||(this._markerTypeCache={});const r=`${e}-${t.join("-")}`;let s=this._markerTypeCache[r];if(void 0===s){let i=[e];t.length&&i.push(t),this.markerTypes.push(i),s=this.markerTypes.length-1,this._markerTypeCache[r]=s}return s}}var ft={render(e){let t=[];lt(pt,e,t);let r=new mt;return dt(r,t),r.result}};const kt="0.3.0",gt={post(e,t){t.push(["openPost"]),ct(gt,e.sections,t)},"markup-section"(e,t){t.push(["openMarkupSection",e.tagName]),ct(gt,e.markers,t)},"list-section"(e,t){t.push(["openListSection",e.tagName]),ct(gt,e.items,t)},"list-item"(e,t){t.push(["openListItem"]),ct(gt,e.markers,t)},"image-section"(e,t){t.push(["openImageSection",e.src])},"card-section"(e,t){t.push(["openCardSection",e.name,e.payload])},marker(e,t){t.push(["openMarker",e.closedMarkups.length,e.value]),ct(gt,e.openedMarkups,t)},markup(e,t){t.push(["openMarkup",e.tagName,d(e.attributes)])},atom(e,t){t.push(["openAtom",e.closedMarkups.length,e.name,e.value,e.payload]),ct(gt,e.openedMarkups,t)}};class _t{openMarker(e,t){this.markupMarkerIds=[],this.markers.push([0,this.markupMarkerIds,e,t||""])}openAtom(e,t,r,s){const i=this._addAtomTypeIndex(t,r,s);this.markupMarkerIds=[],this.markers.push([1,this.markupMarkerIds,e,i])}openMarkupSection(e){this.markers=[],this.sections.push([1,e,this.markers])}openListSection(e){this.items=[],this.sections.push([3,e,this.items])}openListItem(){this.markers=[],this.items.push(this.markers)}openImageSection(e){this.sections.push([2,e])}openCardSection(e,t){const r=this._addCardTypeIndex(e,t);this.sections.push([10,r])}openPost(){this.atomTypes=[],this.cardTypes=[],this.markerTypes=[],this.sections=[],this.result={version:kt,atoms:this.atomTypes,cards:this.cardTypes,markups:this.markerTypes,sections:this.sections}}openMarkup(e,t){const r=this._findOrAddMarkerTypeIndex(e,t);this.markupMarkerIds.push(r)}_addCardTypeIndex(e,t){let r=[e,t];return this.cardTypes.push(r),this.cardTypes.length-1}_addAtomTypeIndex(e,t,r){let s=[e,t,r];return this.atomTypes.push(s),this.atomTypes.length-1}_findOrAddMarkerTypeIndex(e,t){this._markerTypeCache||(this._markerTypeCache={});const r=`${e}-${t.join("-")}`;let s=this._markerTypeCache[r];if(void 0===s){let i=[e];t.length&&i.push(t),this.markerTypes.push(i),s=this.markerTypes.length-1,this._markerTypeCache[r]=s}return s}}var Ct={render(e){let t=[];lt(gt,e,t);let r=new _t;return dt(r,t),r.result}};const bt="0.3.1",St={post(e,t){t.push(["openPost"]),ct(St,e.sections,t)},"markup-section"(e,t){t.push(["openMarkupSection",e.tagName]),ct(St,e.markers,t)},"list-section"(e,t){t.push(["openListSection",e.tagName]),ct(St,e.items,t)},"list-item"(e,t){t.push(["openListItem"]),ct(St,e.markers,t)},"image-section"(e,t){t.push(["openImageSection",e.src])},"card-section"(e,t){t.push(["openCardSection",e.name,e.payload])},marker(e,t){t.push(["openMarker",e.closedMarkups.length,e.value]),ct(St,e.openedMarkups,t)},markup(e,t){t.push(["openMarkup",e.tagName,d(e.attributes)])},atom(e,t){t.push(["openAtom",e.closedMarkups.length,e.name,e.value,e.payload]),ct(St,e.openedMarkups,t)}};class Et{openMarker(e,t){this.markupMarkerIds=[],this.markers.push([0,this.markupMarkerIds,e,t||""])}openAtom(e,t,r,s){const i=this._addAtomTypeIndex(t,r,s);this.markupMarkerIds=[],this.markers.push([1,this.markupMarkerIds,e,i])}openMarkupSection(e){this.markers=[],this.sections.push([1,e,this.markers])}openListSection(e){this.items=[],this.sections.push([3,e,this.items])}openListItem(){this.markers=[],this.items.push(this.markers)}openImageSection(e){this.sections.push([2,e])}openCardSection(e,t){const r=this._addCardTypeIndex(e,t);this.sections.push([10,r])}openPost(){this.atomTypes=[],this.cardTypes=[],this.markerTypes=[],this.sections=[],this.result={version:bt,atoms:this.atomTypes,cards:this.cardTypes,markups:this.markerTypes,sections:this.sections}}openMarkup(e,t){const r=this._findOrAddMarkerTypeIndex(e,t);this.markupMarkerIds.push(r)}_addCardTypeIndex(e,t){let r=[e,t];return this.cardTypes.push(r),this.cardTypes.length-1}_addAtomTypeIndex(e,t,r){let s=[e,t,r];return this.atomTypes.push(s),this.atomTypes.length-1}_findOrAddMarkerTypeIndex(e,t){this._markerTypeCache||(this._markerTypeCache={});const r=`${e}-${t.join("-")}`;let s=this._markerTypeCache[r];if(void 0===s){let i=[e];t.length&&i.push(t),this.markerTypes.push(i),s=this.markerTypes.length-1,this._markerTypeCache[r]=s}return s}}var At={render(e){let t=[];lt(St,e,t);let r=new Et;return dt(r,t),r.result}};const yt="0.3.2",Mt={post(e,t){t.push(["openPost"]),ct(Mt,e.sections,t)},"markup-section"(e,t){t.push(["openMarkupSection",e.tagName,d(e.attributes)]),ct(Mt,e.markers,t)},"list-section"(e,t){t.push(["openListSection",e.tagName,d(e.attributes)]),ct(Mt,e.items,t)},"list-item"(e,t){t.push(["openListItem"]),ct(Mt,e.markers,t)},"image-section"(e,t){t.push(["openImageSection",e.src])},"card-section"(e,t){t.push(["openCardSection",e.name,e.payload])},marker(e,t){t.push(["openMarker",e.closedMarkups.length,e.value]),ct(Mt,e.openedMarkups,t)},markup(e,t){t.push(["openMarkup",e.tagName,d(e.attributes)])},atom(e,t){t.push(["openAtom",e.closedMarkups.length,e.name,e.value,e.payload]),ct(Mt,e.openedMarkups,t)}};class wt{openMarker(e,t){this.markupMarkerIds=[],this.markers.push([0,this.markupMarkerIds,e,t||""])}openAtom(e,t,r,s){const i=this._addAtomTypeIndex(t,r,s);this.markupMarkerIds=[],this.markers.push([1,this.markupMarkerIds,e,i])}openMarkupSection(e,t){this.markers=[],t&&0!==t.length?this.sections.push([1,e,this.markers,t]):this.sections.push([1,e,this.markers])}openListSection(e,t){this.items=[],t&&0!==t.length?this.sections.push([3,e,this.items,t]):this.sections.push([3,e,this.items])}openListItem(){this.markers=[],this.items.push(this.markers)}openImageSection(e){this.sections.push([2,e])}openCardSection(e,t){const r=this._addCardTypeIndex(e,t);this.sections.push([10,r])}openPost(){this.atomTypes=[],this.cardTypes=[],this.markerTypes=[],this.sections=[],this.result={version:yt,atoms:this.atomTypes,cards:this.cardTypes,markups:this.markerTypes,sections:this.sections}}openMarkup(e,t){const r=this._findOrAddMarkerTypeIndex(e,t);this.markupMarkerIds.push(r)}_addCardTypeIndex(e,t){let r=[e,t];return this.cardTypes.push(r),this.cardTypes.length-1}_addAtomTypeIndex(e,t,r){let s=[e,t,r];return this.atomTypes.push(s),this.atomTypes.length-1}_findOrAddMarkerTypeIndex(e,t){this._markerTypeCache||(this._markerTypeCache={});const r=`${e}-${t.join("-")}`;let s=this._markerTypeCache[r];if(void 0===s){let i=[e];t.length&&i.push(t),this.markerTypes.push(i),s=this.markerTypes.length-1,this._markerTypeCache[r]=s}return s}}var vt={render(e){let t=[];lt(Mt,e,t);let r=new wt;return dt(r,t),r.result}},Nt={parse(e,t){switch(t.version){case ut:return new nt(e).parse(t);case kt:return new at(e).parse(t);case bt:return new ot(e).parse(t);case yt:return new ht(e).parse(t);default:T(`Unknown version of mobiledoc parser requested: ${t.version}`,!1)}}};class Tt{constructor(e,t,r,s,i){this._rendered=null,this._teardownCallback=null,this._didRenderCallback=null,this.editor=e,this.card=t,this.section=r,this.element=s,this.options=i}render(e){if(this.mode===e)return;this.teardown(),this.mode=e;let t="display"===e?"render":"edit",r=this.card[t];T(`Card is missing "${t}" (tried to render mode: "${e}")`,!!r);let s=r({env:this.env,options:this.options,payload:this.section.payload})||null;this._validateAndAppendRenderResult(s)}teardown(){this._teardownCallback&&(this._teardownCallback(),this._teardownCallback=null),this._rendered&&(this.element.removeChild(this._rendered),this._rendered=null)}didRender(){this._didRenderCallback&&this._didRenderCallback()}get env(){return{name:this.card.name,isInEditor:!0,onTeardown:e=>this._teardownCallback=e,didRender:e=>this._didRenderCallback=e,edit:()=>this.edit(),save:(e,t=!0)=>{this.section.payload=e,this.editor._postDidChange(),t&&this.display()},cancel:()=>this.display(),remove:()=>this.remove(),postModel:this.section}}display(){this.render(ee.DISPLAY)}edit(){this.render(ee.EDIT)}remove(){this.editor.run((e=>e.removeSection(this.section)))}_validateAndAppendRenderResult(e){if(!e)return;let{card:{name:t}}=this;T(`Card "${t}" must render dom (render value was: "${e}")`,!!e.nodeType),this.element.appendChild(e),this._rendered=e,this.didRender()}}class Rt{constructor(e,t,r,s,i){this._teardownCallback=null,this.editor=e,this.atom=t,this.model=r,this.atomOptions=i,this.element=s}render(){if(!this._rendered){let{atomOptions:e,env:t,model:{value:r,payload:s}}=this;this._rendered=this.atom.render({options:e,env:t,value:r,payload:s})||null}this._validateAndAppendRenderResult(this._rendered)}get env(){return{name:this.atom.name,onTeardown:e=>this._teardownCallback=e,save:(e,t={})=>{this.model.value=e,this.model.payload=t,this.editor._postDidChange(),this.teardown(),this.render()}}}teardown(){this._teardownCallback&&(this._teardownCallback(),this._teardownCallback=null),this._rendered&&(this.element.removeChild(this._rendered),this._rendered=null)}_validateAndAppendRenderResult(e){if(!e)return;let{atom:{name:t}}=this;T(`Atom "${t}" must return a DOM node (returned value was: "${e}")`,!!e.nodeType),this.element.appendChild(e)}}const It="\xa0",Lt=" ",xt="\u200c",Dt="-mobiledoc-kit__atom",Ot="__has-no-content";function Pt(e,t){let r=e.createElement(t.tagName);return Object.keys(t.attributes).forEach((e=>{r.setAttribute(e,t.attributes[e])})),r}const Bt=new RegExp("  ","g"),Ht=new RegExp("\t","g"),Ft=function(e){return y(e,Lt)};function $t(e){let t=e.value;return t=t.replace(Bt," \xa0").replace(Ht,"\u2003"),e.isMarker&&Ft(t)&&!e.next&&(t=t.substr(0,t.length-1)+It),e.isMarker&&function(e){return t=Lt,e.charAt(0)===t;var t}(t)&&(!e.prev||e.prev.isMarker&&Ft(e.prev.value))&&(t=It+t.substr(1)),t}function Ut(e,t){e.eachAttribute(((e,r)=>{t.setAttribute(e,r)}))}function Kt(){return document.createElement("br")}function Wt(){return document.createTextNode(xt)}function jt(e,t){let r=e;for(let s=t.length-1;s>=0;s--){let e=t[s],i=Pt(document,e);i.appendChild(r),r=i}return r}function qt(e,t,r=null){if(r){let s=function(e,t){for(;t&&e.parentNode!==t&&e.parentNode!==document.body;)e=e.parentNode;return e}(r.element,t);t.insertBefore(e,s.nextSibling)}else t.insertBefore(e,t.firstChild)}function Gt(e){let t=e.element.parentNode,r=e.postNode.closedMarkups.length;for(;r--;)t=t.parentNode;return t}function Vt(e,t=null){const r=D(e.element);if(I("expected RenderNode to have a parent",e.parent),t){e.parent.element.replaceChild(r,t)}else{let t,s;if(e.prev){let r=D(e.prev.element);t=D(r.parentNode),s=r.nextSibling}else t=e.parent.element,s=t.firstChild;t.insertBefore(r,s)}}function zt(e,t){I("expected RenderNode to have a parent",e.parent),I("expected parent RenderNode to have a PostNode",e.parent.postNode);const r=e.parent.postNode;T("expected PostNode to have sections",be(r)),r.sections.remove(t)}function Jt(e){e.element&&e.element.parentNode&&e.element.parentNode.removeChild(e.element)}class Qt{constructor(e,t,r,s,i,a){this.editor=e,this.cards=function(e=[]){return n(e,(e=>{T(`Card "${e.name}" must define type "dom", has: "${e.type}"`,"dom"===e.type),T(`Card "${e.name}" must define \`render\` method`,!!e.render)})),e}(t),this.atoms=function(e=[]){return n(e,(e=>{T(`Atom "${e.name}" must define type "dom", has: "${e.type}"`,"dom"===e.type),T(`Atom "${e.name}" must define \`render\` method`,!!e.render)})),e}(r),this.unknownCardHandler=s,this.unknownAtomHandler=i,this.options=a}_findCard(e){return s(this.cards,(t=>t.name===e))||this._createUnknownCard(e)}_createUnknownCard(e){return T(`Unknown card "${e}" found, but no unknownCardHandler is defined`,!!this.unknownCardHandler),{name:e,type:"dom",render:this.unknownCardHandler,edit:this.unknownCardHandler}}_findAtom(e){return s(this.atoms,(t=>t.name===e))||this._createUnknownAtom(e)}_createUnknownAtom(e){return T(`Unknown atom "${e}" found, but no unknownAtomHandler is defined`,!!this.unknownAtomHandler),{name:e,type:"dom",render:this.unknownAtomHandler}}post(e,t,r){e.element||(e.element=document.createElement("div"));let s=e.element;E(s,"__mobiledoc-editor"),t.hasContent?function(e,t){e.classList.remove(t)}(s,Ot):E(s,Ot),r(e,t.sections)}"markup-section"(e,t,r){const s=e.element;if(e.element=function(e){let t;return-1!==Je.indexOf(e.tagName)?t=document.createElement(e.tagName):(t=document.createElement("div"),E(t,e.tagName)),Ut(e,t),t}(t),e.cursorElement=null,Vt(e,s),t.isBlank){let t=Kt();e.element.appendChild(t),e.cursorElement=t}else{const s=!0;r(e,t.markers,s)}}"list-section"(e,t,r){const s=e.element;e.element=function(e){let t=document.createElement(e.tagName);return Ut(e,t),t}(t),Vt(e,s);r(e,t.items,!0)}"list-item"(e,t,r){if(e.element=document.createElement("li"),e.cursorElement=null,Vt(e,null),t.isBlank){let t=Kt();e.element.appendChild(t),e.cursorElement=t}else{const s=!0;r(e,t.markers,s)}}marker(e,t){let r;r=e.prev?Gt(e.prev):e.parent.element;let{element:s,markupElement:i}=function(e,t,r){let s=$t(e),i=document.createTextNode(s),n=jt(i,e.openedMarkups);return qt(n,t,r),{element:i,markupElement:n}}(t,r,e.prev);e.element=s,e.markupElement=i}"image-section"(e,t){if(e.element)e.element.src!==t.src&&(e.element.src=t.src||"");else{let r=document.createElement("img");if(r.src=t.src||"",e.prev){let t=e.prev.element.nextSibling;t&&t.parentNode.insertBefore(r,t)}r.parentNode||e.parent.element.appendChild(r),e.element=r}}"card-section"(e,t){const r=e.element,{editor:s,options:i}=this,n=this._findCard(t.name);let{wrapper:a,cardElement:o}=function(){let e=document.createElement("div"),t=document.createElement("div");return t.contentEditable="false",E(t,"__mobiledoc-card"),e.appendChild(Wt()),e.appendChild(t),e.appendChild(Wt()),{wrapper:e,cardElement:t}}();e.element=a,Vt(e,r);const h=new Tt(s,n,t,o,i);e.cardNode=h;h[t._initialMode]()}atom(e,t){let r;r=e.prev?Gt(e.prev):e.parent.element;const{editor:s,options:i}=this,{wrapper:n,markupElement:a,atomElement:o,headTextNode:h,tailTextNode:l}=function(e,t,r){let s=document.createElement("span");s.contentEditable="false";let i=document.createElement("span");E(i,Dt);let n=Wt(),a=Wt();i.appendChild(n),i.appendChild(s),i.appendChild(a);let o=jt(i,e.openedMarkups);return qt(o,t,r),{markupElement:o,wrapper:i,atomElement:s,headTextNode:n,tailTextNode:a}}(t,r,e.prev),d=this._findAtom(t.name);let c=e.atomNode;c?c.element=o:c=new Rt(s,d,t,o,i),c.render(),e.atomNode=c,e.element=n,e.headTextNode=h,e.tailTextNode=l,e.markupElement=a}}let Yt={post(){T("post destruction is not supported by the renderer",!1)},"markup-section"(e,t){zt(e,t),Jt(e)},"list-section"(e,t){zt(e,t),Jt(e)},"list-item"(e,t){zt(e,t),Jt(e)},marker(e,t){if(!e.isRendered)return;let{markupElement:r}=e;t.section&&t.section.markers.remove(t),r.parentNode&&r.parentNode.removeChild(r)},"image-section"(e,t){zt(e,t),Jt(e)},"card-section"(e,t){e.cardNode&&e.cardNode.teardown(),zt(e,t),Jt(e)},atom(e,t){e.atomNode&&e.atomNode.teardown(),Yt.marker(e,t)}};function Zt(e,t=!1){let r,s,i=e.childNodes.head;for(;i;)r=i.next,(i.isRemoved||t)&&(Zt(i,!0),s=i.postNode.type,R(`editor-dom cannot destroy "${s}"`,s,Yt),Yt[s](i,i.postNode),e.childNodes.remove(i)),i=r}class Xt{constructor(e,t,r,s,i,n){this.renderTree=null,this.editor=e,this.visitor=new Qt(e,t,r,s,i,n),this.nodes=[],this.hasRendered=!1}destroy(){if(!this.hasRendered)return;Zt(D(this.renderTree).rootNode,!0)}visit(e,t,r,s=!1){let i;r.forEach((r=>{let n=function(e,t,r,s){if(r.renderNode)return r.renderNode;{const i=e.buildRenderNode(r);return t.childNodes.insertAfter(i,s),i}}(e,t,r,i);(n.isDirty||s)&&this.nodes.push(n),i=n}))}render(e){this.hasRendered=!0,this.renderTree=e;let t,r,s=e.rootNode;for(;s;)Zt(s),r=s.postNode,t=r.type,R(`EditorDom visitor cannot handle type ${t}`,t,this.visitor),this.visitor[t](s,r,((...t)=>this.visit(e,...t))),s.markClean(),s=this.nodes.shift()}}const er=["a","b","code","em","i","s","del","strong","sub","sup","u"].map(A),tr=["href","rel"];class rr{constructor(e,t={}){this.type="markup",T(`Cannot create markup of tagName ${e}`,-1!==er.indexOf(e)),this.tagName=A(e),T("Must use attributes object param (not array) for Markup",!Array.isArray(t)),this.attributes=function(e,t=[]){let r={};return n(a(Object.keys(e),(e=>-1!==t.indexOf(e))),(t=>r[t]=e[t])),r}(t,tr)}isForwardInclusive(){return this.tagName!==A("a")}isBackwardInclusive(){return!1}hasTag(e){return this.tagName===A(e)}getAttribute(e){return this.attributes[e]}static isValidElement(e){const t=A(e.tagName);return-1!==er.indexOf(t)}}const sr=["style","head","title","meta"].map(A),ir=/\s*\n\s*/g;class nr{constructor(e,t={}){this.builder=e,this.plugins=t.plugins||[]}parse(e){if(this._isSkippable(e))return[];this.sections=[],this.state={},this._updateStateFromElement(e);let t=!1;if(g(e)||(t=this.runPlugins(e)),!t){n(g(e)?[e]:e.childNodes,(e=>{this.parseNode(e)}))}return this._closeCurrentSection(),this.sections}runPlugins(e){let t=!1,r={addSection:e=>{this.state.section&&De(this.state.section)&&!this.state.section.text&&!this.state.text?this.state.section=null:this._closeCurrentSection(),this.sections.push(e)},addMarkerable:e=>{let{state:t}=this,{section:r}=t;r||(t.text="",t.section=this.builder.createMarkupSection(A("p")),r=t.section),L("Markerables can only be appended to markup sections and list item sections",0,r&&r.isMarkerable),t.text&&this._createMarker(),r.markers.append(e)},nodeFinished(){t=!0}};for(let s=0;s<this.plugins.length;s++){if((0,this.plugins[s])(e,this.builder,r),t)return!0}return!1}parseNode(e){if(this.state.section||this._updateStateFromElement(e),!this.runPlugins(e)){if(this.state.section&&C(e)&&e.tagName){let t=A(e.tagName),r=u(Ue,t),s=u(qe,t),i=u(ze,t),a=r&&this.state.section.isListItem,o=this.sections[this.sections.length-1];if(s&&Ze(this.state.section)&&(this._closeCurrentSection(),this._updateStateFromElement(e.parentElement)),s&&o&&je(o)){let t=x(e.parentElement,"expected node to have parent element");A(t.tagName)!==o.tagName&&(this._closeCurrentSection(),this._updateStateFromElement(t))}if(!s||this.state.section.isListItem||this.state.section.isListSection||o.isListSection||(this._closeCurrentSection(),this._updateStateFromElement(e.parentElement)),o&&je(o)&&this.state.section.isListItem&&r&&t!==o.tagName||r&&!a||i||s){if(this.state.section.isListItem&&"p"===t&&!e.nextSibling&&u(qe,A(x(e.parentElement,"expected node to have parent element").tagName)))return void this.parseElementNode(e);De(this.state.section)&&!this.state.text&&0===this.state.section.markers.length?this.state.section=null:this._closeCurrentSection(),this._updateStateFromElement(e)}if(this.state.section&&this.state.section.isListSection)return this._closeCurrentSection(),void n(e.childNodes,(e=>{this.parseNode(e)}))}switch(e.nodeType){case f:this.parseTextNode(e);break;case m:this.parseElementNode(e)}}}parseElementNode(e){let{state:t}=this;T("expected markups to be non-null",t.markups);const r=this._markupsFromElement(e);r.length&&t.text.length&&De(t.section)&&this._createMarker(),t.markups.push(...r),n(e.childNodes,(e=>{this.parseNode(e)})),r.length&&t.text.length&&t.section.isMarkerable&&this._createMarker(),t.markups.splice(-r.length,r.length)}parseTextNode(e){let{state:t}=this;t.text+=e.textContent.replace(ir," ")}_updateStateFromElement(e){if(_(e))return;let{state:t}=this;t.section=this._createSectionFromElement(e),t.markups=this._markupsFromElement(e),t.text=""}_closeCurrentSection(){let{sections:e,state:t}=this,r=e[e.length-1];if(t.section){if(t.text.length&&t.section.isMarkerable&&this._createMarker(),Ve(t.section)&&r&&je(r))dr(t.section),r.items.append(t.section);else{if(De(t.section)&&!t.section.text.trim()&&!i(t.section.markers,(e=>e.isAtom)))return t.section=null,void(t.text="");r&&je(r)&&0===r.items.length&&e.pop(),e.push(t.section)}t.section=null,t.text=""}}_markupsFromElement(e){let{builder:t}=this,r=[];if(g(e))return r;const s=A(e.tagName);return this._isValidMarkupForElement(s,e)&&r.push(t.createMarkup(s,S(e))),this._markupsFromElementStyle(e).forEach((e=>r.push(e))),r}_isValidMarkupForElement(e,t){return-1!==er.indexOf(e)&&("b"!==e||"normal"!==t.style.fontWeight)}_markupsFromElementStyle(e){let{builder:t}=this,r=[],{fontStyle:s,fontWeight:i}=e.style;return"italic"===s&&r.push(t.createMarkup("em")),"bold"!==i&&"700"!==i||r.push(t.createMarkup("strong")),r}_createMarker(){let{state:e}=this,t=lr(e.text),r=this.builder.createMarker(t,e.markups);L("expected section to be markerable",e.section,De(e.section)),e.section.markers.append(r),e.text=""}_getSectionDetails(e){let t,r,s=!1;return g(e)?(r=Qe,t=Oe,s=!0):(r=A(e.tagName),"p"===r&&e.parentElement&&"blockquote"===A(e.parentElement.tagName)&&(r="blockquote"),u(Ue,r)?t=Pe:u(qe,r)?t=Be:u(ze,r)?t=Oe:(t=Oe,r=Qe,s=!0)),{sectionType:t,tagName:r,inferredTagName:s}}_createSectionFromElement(e){if(_(e))return;let t,{builder:r}=this,{tagName:s,sectionType:i,inferredTagName:n}=this._getSectionDetails(e);switch(i){case Pe:t=r.createListSection(s);break;case Be:t=r.createListItem();break;case Oe:t=r.createMarkupSection(s),t._inferredTagName=n;break;default:T("Cannot parse section from element",!1)}return t}_isSkippable(e){return C(e)&&u(sr,A(e.tagName))}}const ar=/^docs-internal-guid/,or=new RegExp(It,"g"),hr=new RegExp("\u2003","g");function lr(e){let t=e;return t=t.replace(or," "),t=t.replace(hr,"\t"),t}function dr(e){if(De(e)&&e.markers.length){let{head:t,tail:r}=e.markers;t.value=t.value.replace(/^\s+/,""),r.value=r.value.replace(/\s+$/,"")}}function cr(e){return C(e)&&A(e.tagName)===A("b")&&ar.test(e.id)}const ur={b:"strong",i:"em"};function pr(e,t){let r=e;if(g(r)||C(r)&&r.classList.contains(Dt))t(r);else for(r=r.firstChild;r;)pr(r,t),r=r.nextSibling}class mr{constructor(e,t={}){this.builder=e,this.sectionParser=new nr(this.builder,t)}parse(e){const t=this.builder.createPost();let r=function(e){return s(e.childNodes||[],cr)||e}(e);return this._eachChildNode(r,(e=>{let r=this.parseSections(e);this.appendSections(t,r)})),n(t.sections,(e=>dr(e))),t}appendSections(e,t){n(t,(t=>this.appendSection(e,t)))}appendSection(e,t){if(t.isBlank||De(t)&&""===t.text.replace(/^\s+/,"").replace(/\s+$/,"")&&!i(t.markers,(e=>e.isAtom)))return;let r=e.sections.tail;r&&Xe(r)&&Xe(t)&&r.tagName===t.tagName?r.join(t):e.sections.append(t)}_eachChildNode(e,t){n(g(e)?[e]:e.childNodes,(e=>t(e)))}parseSections(e){return this.sectionParser.parse(e)}collectMarkups(e,t){let r=[],s=e.parentNode;for(;s&&s!==t;){let e=this.markupFromNode(s);e&&r.push(e),s=s.parentNode}return r}markupFromNode(e){if(C(e)&&rr.isValidElement(e)){let t=function(e){let t=A(e);return ur[t]||t}(e.tagName),r=S(e);return this.builder.createMarkup(t,r)}}reparseSection(e,t){switch(e.type){case Pe:return this.reparseListSection(e,t);case Be:return this.reparseListItem(e,t);case Oe:return this.reparseMarkupSection(e,t);default:return}}reparseMarkupSection(e,t){return this._reparseSectionContainingMarkers(e,t)}reparseListItem(e,t){return this._reparseSectionContainingMarkers(e,t)}reparseListSection(e,t){e.items.forEach((e=>this.reparseListItem(e,t)))}_reparseSectionContainingMarkers(e,t){let r,s=e.renderNode.element,i=[];pr(s,(n=>{let a,o=t.getElementRenderNode(n);if(o){if("marker"===o.postNode.type){let e=lr(n.textContent||""),t=this.collectMarkups(n,s);e.length?(a=o.postNode,a.value=e,a.markups=t):o.scheduleForRemoval()}else if(ie(o.postNode)){let{headTextNode:s,tailTextNode:n}=o;if(s.textContent!==xt){let n=s.textContent.replace(new RegExp(xt,"g"),"");if(s.textContent=xt,r&&r.isMarker)r.value+=n,r.renderNode&&r.renderNode.markDirty();else{let r=o.postNode,s=r.markups.slice(),a=this.builder.createMarker(n,s);e.markers.insertBefore(a,r);let h=t.buildRenderNode(a);h.markDirty(),e.renderNode.markDirty(),i.push(h),e.renderNode.childNodes.insertBefore(h,o)}}if(n.textContent!==xt){let r=n.textContent.replace(new RegExp(xt,"g"),"");if(n.textContent=xt,o.postNode.next&&o.postNode.next.isMarker){let e=o.postNode.next;if(e.renderNode){let t=e.renderNode.element.textContent;e.renderNode.element.textContent=r+t}else{let t=r+e.value;e.value=t}}else{let s=o.postNode,n=s.markups.slice(),a=this.builder.createMarker(r,n);e.markers.insertAfter(a,s);let h=t.buildRenderNode(a);i.push(h),h.markDirty(),e.renderNode.markDirty(),e.renderNode.childNodes.insertAfter(h,o)}}o&&(a=o.postNode)}}else if(g(n)){let i=lr(n.textContent),h=this.collectMarkups(n,s);a=this.builder.createMarker(i,h),o=t.buildRenderNode(a),o.element=n,o.markClean(),e.renderNode.markDirty();let l=r&&r.renderNode;e.markers.insertAfter(a,r),e.renderNode.childNodes.insertAfter(o,l)}o&&i.push(o),r=a}));let n=e.renderNode.childNodes.head;for(;n;)-1===i.indexOf(n)&&n.scheduleForRemoval(),n=n.next}}class fr{constructor(e,t={}){T("Must pass builder to HTMLParser",e),this.builder=e,this.options=t}parse(e){let t=function(e){const t=document.createElement("div");return t.innerHTML=e,t}(e);return new mr(this.builder,this.options).parse(t)}}class kr extends Q{constructor(e,t){super(),this.parent=null,this.isDirty=!0,this.isRemoved=!1,this.markupElement=null,this.headTextNode=null,this.tailTextNode=null,this.atomNode=null,this.cardNode=null,this._childNodes=null,this._element=null,this._cursorElement=null,this.postNode=e,this.renderTree=t}isAttached(){return T("Cannot check if a renderNode is attached without an element.",!!this.element),b(D(D(this.renderTree).rootElement),this.element)}get childNodes(){return this._childNodes||(this._childNodes=new Re({adoptItem:e=>e.parent=this,freeItem:e=>e.destroy()})),this._childNodes}scheduleForRemoval(){this.isRemoved=!0,this.parent&&this.parent.markDirty()}markDirty(){this.isDirty=!0,this.parent&&this.parent.markDirty()}get isRendered(){return!!this.element}markClean(){this.isDirty=!1}get element(){return this._element}set element(e){const t=this._element;this._element=e,t&&this.renderTree.removeElementRenderNode(t),e&&this.renderTree.setElementRenderNode(e,this)}set cursorElement(e){this._cursorElement=e}get cursorElement(){return this._cursorElement||this.element}destroy(){this.element=null,this.parent=null,this.postNode=null,this.renderTree=null}reparsesMutationOfChildNode(e){return this.postNode.isCardSection?!b(this.cardNode.element,e):!this.postNode.isAtom||!b(this.atomNode.element,e)}}let gr=1;class _r{constructor(){this._map={}}set(e,t){let r=e._uuid;r||(e._uuid=r=""+gr++),this._map[r]=t}get(e){return e._uuid?this._map[e._uuid]:null}remove(e){!function(e){T("tried to fetch a value for an element not seen before",!!e._uuid)}(e),delete this._map[e._uuid]}}class Cr{constructor(e){this._rootNode=this.buildRenderNode(e),this._elements=new _r}get rootNode(){return this._rootNode}get isDirty(){return this.rootNode&&this.rootNode.isDirty}get rootElement(){return this.rootNode.element}getElementRenderNode(e){return this._elements.get(e)}setElementRenderNode(e,t){this._elements.set(e,t)}removeElementRenderNode(e){this._elements.remove(e)}findRenderNodeFromElement(e,t=(()=>!0)){let r,s=e;for(;s;){if(r=this.getElementRenderNode(s),r&&t(r))return r;if(s=s.parentElement,s===this.rootElement)return t(this.rootNode)?this.rootNode:void 0}}buildRenderNode(e){const t=new kr(e,this);return e.renderNode=t,t}}const br=yt;var Sr={render(e,t="0.3.2"){switch(t){case ut:return ft.render(e);case kt:return Ct.render(e);case bt:return At.render(e);case void 0:case null:case yt:return vt.render(e);default:T(`Unknown version of mobiledoc renderer requested: ${t}`,!1)}}};var Er={hasDOM:()=>"undefined"!==typeof document};class Ar{constructor(){this.type="post",this.sections=new Re({adoptItem:e=>e.post=e._parent=this,freeItem:e=>e.post=e._parent=null})}headPosition(){return this.isBlank?ce.blankPosition():this.sections.head.headPosition()}tailPosition(){return this.isBlank?ce.blankPosition():this.sections.tail.tailPosition()}toRange(){return this.headPosition().toRange(this.tailPosition())}get isBlank(){return this.sections.isEmpty}get hasContent(){return this.sections.length>1||1===this.sections.length&&!this.sections.head.isBlank}markersContainedByRange(e){const t=[];return this.walkMarkerableSections(e,(r=>{r._markersInRange(e.trimTo(r),((e,{isContained:r})=>{r&&t.push(e)}))})),t}markupsInRange(e){const t=new Te;if(e.isCollapsed){let r=e.head;if(r.isMarkerable){let[e,s]=[r.markerIn(-1),r.markerIn(1)];e&&s&&e===s?e.markups.forEach((e=>t.add(e))):((e&&e.markups||[]).forEach((e=>{e.isForwardInclusive()&&t.add(e)})),(s&&s.markups||[]).forEach((e=>{e.isBackwardInclusive()&&t.add(e)})))}}else this.walkMarkerableSections(e,(r=>{n(r.markupsInRange(e.trimTo(r)),(e=>t.add(e)))}));return t.toArray()}walkAllLeafSections(e){let t=this.headPosition().toRange(this.tailPosition());return this.walkLeafSections(t,e)}walkLeafSections(e,t){const{head:r,tail:s}=e;let i,n,a=0,o=r.section;for(;o&&(i=this._nextLeafSection(o),n=o===s.section,t(o,a),a++,!n);)o=i}walkMarkerableSections(e,t){this.walkLeafSections(e,(e=>{De(e)&&t(e)}))}_nextLeafSection(e){if(!e)return null;const t=e.next;return t?t.isLeafSection?t:je(t)?t.items.head:void T("Cannot determine next section from non-leaf-section",!1):X(e)?this._nextLeafSection(e.parent):null}trimTo(e){const{builder:t}=this,r=t.createPost(),{head:s,tail:i}=e,a=0===i.offset&&s.section!==i.section;let o=r,h=null;return this.walkLeafSections(e,(s=>{let l;if(De(s)){if(Ve(s))h||(h=t.createListSection(s.parent.tagName),r.sections.append(h)),o=null,l=t.createListItem(),h.items.append(l);else{h=null,o=r;const e=a&&i.section===s?"p":s.tagName;l=t.createMarkupSection(e)}let d=e.trimTo(s);n(s.markersFor(d.headSectionOffset,d.tailSectionOffset),(e=>l.markers.append(e)))}else l=a&&i.section===s?t.createMarkupSection("p"):function(e){if(!("clone"in e))throw new Error("Expected section to be cloneable");return e}(s).clone(),o=r;o&&o.sections.append(l)})),r}}class yr extends Z{constructor(){super("image-section"),this.src=null}clone(){return this.builder.createImageSection(this.src)}canJoin(){return!1}get length(){return 1}}function Mr(e,t){return`${A(e)}-${d(t).join("-")}`}class wr{constructor(){this.markupCache={}}createPost(e=[]){const t=new Ar;return t.builder=this,e.forEach((e=>t.sections.append(e))),t}createMarkerableSection(e,t,r=[]){switch(e){case Be:return this.createListItem(r);case Oe:return this.createMarkupSection(t,r);default:T(`Cannot create markerable section of type ${e}`,!1)}}createMarkupSection(e=Qe,t=[],r=!1,s={}){e=A(e);const i=new Ye(e,t,s);return r&&(i.isGenerated=!0),i.builder=this,i}createListSection(e=Ke,t=[],r={}){e=A(e);const s=new We(e,t,r);return s.builder=this,s}createListItem(e=[]){const t=A("li"),r=new Ge(t,e);return r.builder=this,r}createImageSection(e){let t=new yr;return e&&(t.src=e),t.builder=this,t}createCardSection(e,t={}){const r=new re(e,t);return r.builder=this,r}createMarker(e,t=[]){const r=new B(e,t);return r.builder=this,r}createAtom(e,t="",r={},s=[]){const i=new se(e,t,r,s);return i.builder=this,i}createMarkup(e,t={}){e=A(e);let r=function(e,t,r){return e[Mr(t,r)]}(this.markupCache,e,t);return r||(r=new rr(e,t),r.builder=this,function(e,t){e[Mr(t.tagName,t.attributes)]=t}(this.markupCache,r)),r}}function vr(e,t){const{range:r}=e,{head:s}=r,{section:i}=s;s.isTail()&&(i.isListItem||e.run((e=>{let{builder:r}=e,s=r.createListItem(),n=r.createListSection(t,[s]);e.replaceSection(i,n),e.setRange(n.headPosition())})))}const Nr=[{name:"ul",match:/^\* $/,run(e){vr(e,"ul")}},{name:"ol",match:/^1\.? $/,run(e){vr(e,"ol")}},{name:"heading",match:/^(#{1,6}) $/,run(e,t){!function(e,t){let{range:{head:r,head:{section:s}}}=e;r.isTail()&&e.run((e=>{let{builder:r}=e,i=r.createMarkupSection(t);e.replaceSection(s,i),e.setRange(i.headPosition())}))}(e,"h"+t[1].length)}}];var Tr={isMac:()=>"undefined"!==typeof window&&window.navigator&&/Mac/.test(window.navigator.platform),isWin:()=>"undefined"!==typeof window&&window.navigator&&/Win/.test(window.navigator.platform),isChrome:()=>"undefined"!==typeof window&&"chrome"in window};function Rr(e){let{post:t}=e;e.selectRange(t.toRange())}const Ir=[{str:"META+B",run(e){e.toggleMarkup("strong")}},{str:"CTRL+B",run(e){e.toggleMarkup("strong")}},{str:"META+I",run(e){e.toggleMarkup("em")}},{str:"CTRL+I",run(e){e.toggleMarkup("em")}},{str:"META+U",run(e){e.toggleMarkup("u")}},{str:"CTRL+U",run(e){e.toggleMarkup("u")}},{str:"CTRL+K",run:e=>Tr.isMac()?function(e){let{range:t}=e;if(t.isCollapsed){let{head:e,head:{section:r}}=t;t=e.toRange(r.tailPosition())}e.run((e=>{let r=e.deleteRange(t);e.setRange(r)}))}(e):Tr.isWin()?me(e):void 0},{str:"CTRL+A",run(e){Tr.isMac()?function(e){let{range:t}=e,{tail:{section:r}}=t;e.run((e=>{e.setRange(r.headPosition())}))}(e):Rr(e)}},{str:"META+A",run(e){Tr.isMac()&&Rr(e)}},{str:"CTRL+E",run(e){Tr.isMac()&&function(e){let{range:t}=e,{tail:{section:r}}=t;e.run((e=>{e.setRange(r.tailPosition())}))}(e)}},{str:"META+K",run:e=>me(e)},{str:"META+Z",run(e){e.run((e=>{e.undoLastChange()}))}},{str:"META+SHIFT+Z",run(e){e.run((e=>{e.redoLastChange()}))}},{str:"CTRL+Z",run(e){if(Tr.isMac())return!1;e.run((e=>e.undoLastChange()))}},{str:"CTRL+SHIFT+Z",run(e){if(Tr.isMac())return!1;e.run((e=>e.redoLastChange()))}}];function Lr(e){const t=e.toUpperCase(),r=K[t];return r||(T(`Only 1 character can be used in a key command str (got "${e}")`,1===e.length),t.charCodeAt(0))}function xr(e){if(function(e){return void 0===e.str}(e))return e;T("[deprecation] Key commands no longer use the `modifier` property",!e.modifier);let{str:t,run:r,name:s}=e,[i,...n]=t.split("+").reverse();return{name:s,run:r,modifierMask:(a=n,h(a,((e,t)=>{let r=U[t.toUpperCase()];return T(`No modifier named "${t}" found`,!!r),e+r}),0)),code:Lr(i)};var a}class Dr{constructor(e){this.editor=e,this.logger=e.loggerFor("mutation-handler"),this.renderTree=null,this._isObserving=!1,this._observer=new MutationObserver((e=>{this._handleMutations(e)}))}init(){this.startObserving()}destroy(){this.stopObserving(),this._observer=null}suspendObservation(e){this.stopObserving(),e(),this.startObserving()}stopObserving(){this._isObserving&&(this._isObserving=!1,this._observer.disconnect())}startObserving(){if(!this._isObserving){let{editor:e}=this;T("Cannot observe un-rendered editor",e.hasRendered),this._isObserving=!0,this.renderTree=e._renderTree,this._observer.observe(e.element,{characterData:!0,childList:!0,subtree:!0})}}reparsePost(){this.editor._reparsePost()}reparseSections(e){this.editor._reparseSections(e)}_handleMutations(e){let t=!1,r=new Te;for(let s=0;s<e.length&&!t;s++){let i=this._findTargetNodes(e[s]);for(let e=0;e<i.length;e++){let s=i[e],n=this._findRenderNodeFromNode(s);if(!n){t=!0;break}if(n.reparsesMutationOfChildNode(s)){let e=this._findSectionFromRenderNode(n);e?r.add(e):t=!0}}}t?(this.logger.log(`reparsePost (${e.length} mutations)`),this.reparsePost()):r.length&&(this.logger.log(`reparse ${r.length} sections (${e.length} mutations)`),this.reparseSections(r.toArray()))}_findTargetNodes(e){let t=[];switch(e.type){case"characterData":t.push(e.target);break;case"childList":n(e.addedNodes,(e=>t.push(e))),e.removedNodes.length&&t.push(e.target)}let r=this.editor.element;return a(t,(e=>b(r,e)))}_findSectionRenderNodeFromNode(e){return this.renderTree.findRenderNodeFromElement(e,(e=>e.postNode.isSection))}_findRenderNodeFromNode(e){return this.renderTree.findRenderNodeFromElement(e)}_findSectionFromRenderNode(e){let t=this._findSectionRenderNodeFromNode(e.element);return t&&t.postNode}}class Or{constructor(e=0){this._maxLength=e,this._items=[]}get length(){return this._items.length}pop(){return this._items.pop()}push(e){this._items.push(e),this.length>this._maxLength&&this._items.shift()}clear(){this._items=[]}toArray(){return this._items}}function Pr(e,t){let r;return e.walkAllLeafSections(((e,s)=>{t===s&&(r=e)})),r}class Br{constructor(e,t,r=null){this.mobiledoc=t.serialize(),this.editor=t,this.editAction=r,this.takenAt=e,this.snapshotRange()}snapshotRange(){let{range:e,cursor:t}=this.editor;if(t.hasCursor()&&!e.isBlank){let{head:t,tail:r}=e;this.range={head:[t.leafSectionIndex,t.offset],tail:[r.leafSectionIndex,r.offset]}}}getRange(e){if(this.range){let{head:t,tail:r}=this.range,[s,i]=t,[n,a]=r,o=Pr(e,s),h=Pr(e,n),l=o.toPosition(i),d=h.toPosition(a);return l.toRange(d)}}groupsWith(e,t,r){return null!==t&&this.editAction===t&&this.takenAt+e>r}}class Hr{constructor(e,t,r){this.editor=e,this._undoStack=new Or(t),this._redoStack=new Or(t),this._pendingSnapshot=null,this._groupingTimeout=r}snapshot(){this._pendingSnapshot&&this._pendingSnapshot.snapshotRange()}storeSnapshot(e=null){let t=Date.now(),r=this._pendingSnapshot;r&&(r.groupsWith(this._groupingTimeout,e,t)||this._undoStack.push(r),this._redoStack.clear()),this._pendingSnapshot=new Br(t,this.editor,e)}stepBackward(e){this._pendingSnapshot=null;let t=this._undoStack.pop();t&&(this._redoStack.push(new Br(Date.now(),this.editor)),this._restoreFromSnapshot(t,e))}stepForward(e){let t=this._redoStack.pop();t&&(this._undoStack.push(new Br(Date.now(),this.editor)),this._restoreFromSnapshot(t,e)),e.cancelSnapshot()}_restoreFromSnapshot(e,t){let{mobiledoc:r}=e,{editor:s}=this,{builder:i,post:n}=s,a=Nt.parse(i,r);t.removeAllSections(),t.migrateSectionsFromPost(a);let o=e.getRange(n);o&&t.setRange(o)}}const Fr=/^\* (.*)$/,$r=/^\d\.? (.*)$/,Ur="\n",Kr=new RegExp("\r","g"),Wr=new RegExp("\r\n","g");class jr{constructor(e,t){this.builder=e,this.options=t,this.post=this.builder.createPost(),this.prevSection=null}parse(e){return(e=function(e){return e.replace(Wr,Ur).replace(Kr,Ur)}(e)).split("\n").forEach((e=>{let t=this._parseSection(e);this._appendSection(t)})),this.post}_parseSection(e){let t,r=Qe,s=Oe;Fr.test(e)?(r="ul",s=Pe,e=e.match(Fr)[1]):$r.test(e)&&(r="ol",s=Pe,e=e.match($r)[1]);let i=[this.builder.createMarker(e)];switch(s){case Pe:{let e=this.builder.createListItem(i);t=this.builder.createListSection(r,[e]);break}case Oe:t=this.builder.createMarkupSection(r,i);break;default:T(`Unknown type encountered ${s}`,!1)}return t}_appendSection(e){je(e)&&this.prevSection&&je(this.prevSection)&&this.prevSection.tagName===e.tagName?e.items.forEach((e=>{this.prevSection.items.append(e.clone())})):(this.post.sections.insertAfter(e,this.prevSection),this.prevSection=e)}}const qr="text/plain",Gr="text/html",Vr="Text",zr=new RegExp(/data-mobiledoc='(.*?)'>/);function Jr(e,t,r){let s;if(zr.test(e)){let r=e.match(zr)[1],i=JSON.parse(r);s=Nt.parse(t,i)}else s=new fr(t,{plugins:r}).parse(e);return s}function Qr(e,t,r){return new jr(t,{plugins:r}).parse(e)}function Yr(e,{builder:t,_parserPlugins:r},{targetFormat:s}={targetFormat:"html"}){let{html:i,text:n}=function(e,t){let r="",s="",{clipboardData:i}=e;return i&&i.getData?(r=i.getData(Gr),s=i.getData(qr)):t.clipboardData&&t.clipboardData.getData&&(r=t.clipboardData.getData(Vr)),{html:r,text:s}}(e,window);return"html"===s&&i&&i.length?Jr(i,t,r):n&&n.length?Qr(n,t,r):void 0}function Zr(e,t,{logger:r}={}){let{builder:s,_parserPlugins:i}=t,{html:n,text:a}=function(e,t){let r="",s="";try{r=e.dataTransfer.getData(Gr),s=e.dataTransfer.getData(qr)}catch(i){t&&t.log("Error getting drop data: ",i)}return{html:r,text:s}}(e,r);return n&&n.length?Jr(n,s,i):a&&a.length?Qr(a,s,i):void 0}class Xr{constructor(e){this.editor=e,this._handlers=[]}register(e){T("Input Handler is not valid",this._validateHandler(e)),this._handlers.push(e)}unregister(e){let t=this._handlers;for(let r=0;r<t.length;r++)t[r].name===e&&t.splice(r,1)}handle(e){let{editor:t}=this;t.insertText(e);let r=this._findHandler();if(r){let[e,s]=r;e.run(t,s)}}handleNewLine(){let{editor:e}=this,t=this._findHandler("\n");if(t){let[r,s]=t;r.run(e,s)}}_findHandler(e=""){const{editor:t}=this,{range:r}=t,{head:s}=r,{section:i}=s;let n=i.textUntil(s)+e;for(let a=0;a<this._handlers.length;a++){let e=this._handlers[a];if("text"in e&&y(n,e.text))return[e,[e.text]];if("match"in e&&e.match.test(n))return[e,e.match.exec(n)]}}_validateHandler(e){return we('Registered input handlers require a "name" property so that they can be unregistered',!!e.name),!!e.run&&(!!e.text||!!e.match)&&!(e.text&&e.match)}destroy(){this._handlers=[]}}let es;class ts{constructor(){this.started=!1,this.listeners=[],this.selection={}}static getInstance(){return es||(es=new ts),es}static addListener(e){ts.getInstance().addListener(e)}addListener(e){-1===this.listeners.indexOf(e)&&(this.listeners.push(e),this.start())}static removeListener(e){ts.getInstance().removeListener(e)}removeListener(e){let t=this.listeners.indexOf(e);-1!==t&&(this.listeners.splice(t,1),0===this.listeners.length&&this.stop())}start(){this.started||(this.started=!0,this.poll())}stop(){this.started=!1,this.selection={}}notifyListeners(e,t){this.listeners.forEach((r=>{r.selectionDidChange(e,t)}))}destroy(){this.stop(),this.listeners=[]}getSelection(){let e=window.getSelection(),{anchorNode:t,focusNode:r,anchorOffset:s,focusOffset:i}=e;return{anchorNode:t,focusNode:r,anchorOffset:s,focusOffset:i}}poll(){this.started&&(this.update(),this.runNext((()=>this.poll())))}runNext(e){window.requestAnimationFrame(e)}update(){let e=this.selection,t=this.getSelection();this.selectionIsEqual(e,t)||(this.selection=t,this.notifyListeners(t,e))}selectionIsEqual(e,t){return e.anchorNode===t.anchorNode&&e.anchorOffset===t.anchorOffset&&e.focusNode===t.focusNode&&e.focusOffset===t.focusOffset}}class rs{constructor(e,t){this.editor=e,this.callback=t,this.started=!1}start(){this.started||(ts.addListener(this),this.started=!0)}stop(){this.started=!1,ts.removeListener(this)}destroy(){this.stop()}selectionDidChange(e,t){this.started&&this.callback(e,t)}}const ss=["keydown","keyup","cut","copy","paste","keypress","drop","compositionstart","compositionend"];class is{constructor(e){this.editor=e,this.logger=e.loggerFor("event-manager"),this._textInputHandler=new Xr(e),this._listeners=[],this.modifierKeys={shift:!1},this._selectionManager=new rs(this.editor,this.selectionDidChange.bind(this)),this.started=!0,this._isComposingOnBlankLine=!1}init(){let{editor:{element:e}}=this;T("Cannot init EventManager without element",!!e),ss.forEach((t=>{this._addListener(e,t)})),this._selectionManager.start()}start(){this.started=!0}stop(){this.started=!1}registerInputHandler(e){this._textInputHandler.register(e)}unregisterInputHandler(e){this._textInputHandler.unregister(e)}unregisterAllTextInputHandlers(){this._textInputHandler.destroy(),this._textInputHandler=new Xr(this.editor)}_addListener(e,t){T(`Missing listener for ${t}`,!!this[t]);let r=e=>this._handleEvent(t,e);e.addEventListener(t,r),this._listeners.push([e,t,r])}_removeListeners(){this._listeners.forEach((([e,t,r])=>{e.removeEventListener(t,r)})),this._listeners=[]}_trigger(e,t,r){n(a(this._listeners,(([r,s])=>r===e&&s===t)),(([e,,t])=>{t.call(e,r)}))}destroy(){this._textInputHandler.destroy(),this._selectionManager.destroy(),this._removeListeners()}_handleEvent(e,t){let{target:r}=t;return!this.started||(!this.isElementAddressable(r)||void this[e](t))}isElementAddressable(e){return this.editor.cursor.isAddressable(e)}selectionDidChange(e){let t=!0,{anchorNode:r}=e;this.isElementAddressable(r)||(t=!this.editor.range.isBlank),t&&this.editor._readRangeFromDOM()}keypress(e){let{editor:t,_textInputHandler:r}=this;if(!t.hasCursor())return;let s=W.fromEvent(e);if(s.isPrintable()){if(e.preventDefault(),!s.isEnter()&&13===s.keyCode)return r.handleNewLine(),void t.handleNewline(e);r.handle(s.toString())}}keydown(e){let{editor:t}=this;if(!t.hasCursor())return;if(!t.isEditable)return;let r=W.fromEvent(e);if(this._updateModifiersFromKey(r,{isDown:!0}),t.handleKeyCommand(e))return;t.post.isBlank&&t._insertEmptyMarkupSectionAtCursor();let s=t.range;switch(!0){case r.isIME():break;case r.isHorizontalArrowWithoutModifiersOtherThanShift():{let i;i=r.isShift()?s.extend(1*r.direction):s.move(r.direction),t.selectRange(i),e.preventDefault();break}case r.isDelete():{let{direction:s}=r,i=Gs.CHAR;(r.altKey&&Tr.isMac()||r.ctrlKey&&!Tr.isMac())&&(i=Gs.WORD),t.performDelete({direction:s,unit:i}),e.preventDefault();break}case r.isEnter():this._textInputHandler.handleNewLine(),t.handleNewline(e);break;case r.isTab():e.preventDefault(),this._textInputHandler.handle(r.toString())}}keyup(e){let{editor:t}=this;if(!t.hasCursor())return;let r=W.fromEvent(e);this._updateModifiersFromKey(r,{isDown:!1})}compositionstart(e){let{editor:t}=this;t.range.headMarker||(this._isComposingOnBlankLine=!0,t.post.isBlank&&t._insertEmptyMarkupSectionAtCursor(),Tr.isChrome()?(t.setPlaceholder(""),t._mutationHandler.stopObserving()):this._textInputHandler.handle(" "))}compositionend(e){const{editor:t}=this;if(this._isComposingOnBlankLine)if(this._isComposingOnBlankLine=!1,Tr.isChrome())t.insertText(e.data),t.setPlaceholder(t.placeholder),t._mutationHandler.startObserving();else{let r=t.range.headSection.toPosition(0),s=t.range.headSection.toPosition(e.data.length);t.run((e=>{e.deleteAtPosition(r,1,{unit:Gs.CHAR}),e.setRange(s)}))}}cut(e){e.preventDefault(),this.copy(e),this.editor.performDelete()}copy(e){e.preventDefault();let{editor:t,editor:{range:r,post:s}}=this;s=s.trimTo(r);let i={html:t.serializePost(s,qs.HTML),text:t.serializePost(s,qs.TEXT),mobiledoc:t.serializePost(s,qs.MOBILEDOC)};t.runCallbacks("willCopy",[i]),function(e,{mobiledoc:t,html:r,text:s},i){t&&r&&(r=`<div data-mobiledoc='${JSON.stringify(t)}'>${r}</div>`);let{clipboardData:n}=e,{clipboardData:a}=i;n&&n.setData?(n.setData(Gr,r),n.setData(qr,s)):a&&a.setData&&a.setData(Vr,r)}(e,i,window)}paste(e){e.preventDefault();let{editor:t}=this;t.range.isCollapsed||t.performDelete(),t.post.isBlank&&t._insertEmptyMarkupSectionAtCursor();let r=t.range.head,s=Yr(e,t,{targetFormat:this.modifierKeys.shift?"text":"html"});t.run((e=>{let t=e.insertPost(r,s);e.setRange(t)}))}drop(e){e.preventDefault();let{clientX:t,clientY:r}=e,{editor:s}=this,i=s.positionAtPoint(t,r);if(!i)return void this.logger.log("Could not find drop position");let n=Zr(e,s,{logger:this.logger});n?s.run((e=>{let t=e.insertPost(i,n);e.setRange(t)})):this.logger.log("Could not determine post from drop event")}_updateModifiersFromKey(e,{isDown:t}){e.isShiftKey()&&(this.modifierKeys.shift=t)}}class ns{constructor(e){this.editor=e;let t={range:z.blankRange(),activeMarkups:[],activeSections:[],activeSectionTagNames:[],activeSectionAttributes:{}};this.prevState=this.state=t}updateRange(e){this.prevState=this.state,this.state=this._readState(e)}destroy(){this.editor=null,this.prevState=this.state=null}rangeDidChange(){const{state:e,prevState:t}=this,{range:r}=e,{range:s}=t;return!s.isEqual(r)}inputModeDidChange(){const e=this.state,t=this.prevState;return!c(e.activeMarkups,t.activeMarkups)||!c(e.activeSectionTagNames,t.activeSectionTagNames)||!c(d(e.activeSectionAttributes),d(t.activeSectionAttributes))}get range(){return this.state.range}get activeSections(){return this.state.activeSections}get activeSectionAttributes(){return this.state.activeSectionAttributes}get activeMarkups(){return this.state.activeMarkups}toggleMarkupState(e){u(this.activeMarkups,e)?this._removeActiveMarkup(e):this._addActiveMarkup(e)}_readState(e){let t={range:e,activeMarkups:this._readActiveMarkups(e),activeSections:this._readActiveSections(e)};return t.activeSectionTagNames=t.activeSections.map((e=>e.isNested?e.parent.tagName:e.tagName)),t.activeSectionAttributes=this._readSectionAttributes(t.activeSections),t}_readActiveSections(e){const{head:t,tail:r}=e,{editor:s}=this,{post:i}=s;return e.isBlank?[]:i.sections.readRange(t.section,r.section)}_readActiveMarkups(e){const{editor:t}=this,{post:r}=t;return r.markupsInRange(e)}_readSectionAttributes(e){return e.reduce(((e,t)=>{let r=X(s=t)?s.parent.attributes||{}:s.attributes||{};var s;return Object.keys(r).forEach((t=>{let s=t.replace(/^data-md-/,""),i=r[t];e[s]=e[s]||[],u(e[s],i)||e[s].push(i)})),e}),{})}_removeActiveMarkup(e){let t=this.state.activeMarkups.indexOf(e);this.state.activeMarkups.splice(t,1)}_addActiveMarkup(e){this.state.activeMarkups.push(e)}}function as(e,t){return e.createTextNode(function(e){return e.replace(/  /g," \xa0")}(t))}function os(e){return e.toLowerCase()}var hs="dom",ls={name:"image",type:hs,render({payload:e,env:{dom:t}}){let r=t.createElement("img");return r.src=e.src,r}};const ds=["p","h1","h2","h3","h4","h5","h6","blockquote","pull-quote","aside"].map(os),cs=["p","h1","h2","h3","h4","h5","h6","blockquote","aside"].map(os),us=["ul","ol"].map(os),ps=["b","i","strong","em","a","u","sub","sup","s","code"].map(os);function ms(e,t){return-1!==e.indexOf(t)}function fs(e,t){switch(e=os(e),t){case 1:return ms(ds,e);case 3:return ms(us,e);default:throw new Error(`Cannot validate tagName for unknown section type "${t}"`)}}function ks(e){return e=os(e),ms(ps,e)}const gs=/^([a-z0-9.+-]+:)/i,_s=["javascript:","vbscript:"];function Cs(e){let t=function(e){let t=e&&e.match(gs);return t&&t[0]||":"}(e).toLowerCase();return function(e,t){for(let r=0;r<e.length;r++)if(e[r]===t)return!0;return!1}(_s,t)?`unsafe:${e}`:e}function bs(e){let t={};for(let r=0;r<e.length;r+=2){let s=e[r],i=e[r+1];t[s.toLowerCase()]=i}return t}const Ss=["data-md-text-align"];function Es(e,t,r){if(s=t,-1===Ss.indexOf(s))throw new Error(`Cannot use attribute: ${t}`);var s;e.setAttribute(t,r)}function As(e,t,r={}){let s;return!function(e){return e=os(e),ms(cs,e)}(e)?(s=t.createElement("div"),s.setAttribute("class",e)):(s=t.createElement(e),Object.keys(r).forEach((e=>{Es(s,e,r[e])}))),s}function ys(e,t,r){let s=t.createElement(e);return Object.keys(r).forEach((t=>{let i=r[t];i=function(e,t,r){return"a"===e&&"href"===t?Cs(r):r}(e,t,i),s.setAttribute(t,i)})),s}const Ms="0.2.0";class ws{constructor(e,t){let{cards:r,cardOptions:s,unknownCardHandler:i,markupElementRenderer:n,sectionElementRenderer:a,dom:o}=t,{version:h,sections:l}=e;!function(e){if(e!==Ms)throw new Error(`Unexpected Mobiledoc version "${e}"`)}(h);const[d,c]=l;this.dom=o,this.root=o.createDocumentFragment(),this.markerTypes=d,this.sections=c,this.cards=r,this.cardOptions=s,this.unknownCardHandler=i||this._defaultUnknownCardHandler,this.sectionElementRenderer={__default__:As},Object.keys(a).forEach((e=>{this.sectionElementRenderer[e.toLowerCase()]=a[e]})),this.markupElementRenderer={__default__:ys},Object.keys(n).forEach((e=>{this.markupElementRenderer[e.toLowerCase()]=n[e]})),this._renderCallbacks=[],this._teardownCallbacks=[],this._renderedChildNodes=[]}get _defaultUnknownCardHandler(){return({env:{name:e}})=>{throw new Error(`Card "${e}" not found but no unknownCardHandler was registered`)}}render(){this.sections.forEach((e=>{let t=this.renderSection(e);t&&this.root.appendChild(t)}));for(let t=0;t<this._renderCallbacks.length;t++)this._renderCallbacks[t]();this._renderedChildNodes=[];let e=this.root.firstChild;for(;e;)this._renderedChildNodes.push(e),e=e.nextSibling;return{result:this.root,teardown:()=>this.teardown()}}teardown(){for(let e=0;e<this._teardownCallbacks.length;e++)this._teardownCallbacks[e]();for(let e=0;e<this._renderedChildNodes.length;e++){let t=this._renderedChildNodes[e];t.parentNode&&t.parentNode.removeChild(t)}}renderSection(e){const[t]=e;switch(t){case 1:return this.renderMarkupSection(e);case 2:return this.renderImageSection(e);case 3:return this.renderListSection(e);case 10:return this.renderCardSection(e);default:throw new Error(`Cannot render mobiledoc section of type "${t}"`)}}renderMarkersOnElement(e,t){let r=[e],s=e;for(let n=0,a=t.length;n<a;n++){let e=t[n],[a,o,h]=e;for(let t=0,n=a.length;t<n;t++){let e=this.markerTypes[a[t]],[n,h=[]]=e;ks(n)?(i=this.renderMarkupElement(n,h),s.appendChild(i),r.push(i),s=i):o--}s.appendChild(as(this.dom,h));for(let t=0,i=o;t<i;t++)r.pop(),s=r[r.length-1]}var i}renderMarkupElement(e,t){return e=e.toLowerCase(),t=bs(t),this.markupElementRendererFor(e)(e,this.dom,t)}markupElementRendererFor(e){return this.markupElementRenderer[e]||this.markupElementRenderer.__default__}renderListItem(e){const t=this.dom.createElement("li");return this.renderMarkersOnElement(t,e),t}renderListSection([e,t,r]){if(!fs(t,3))return;const s=this.dom.createElement(t);return r.forEach((e=>{s.appendChild(this.renderListItem(e))})),s}renderImageSection([e,t]){let r=this.dom.createElement("img");return r.src=t,r}findCard(e){for(let t=0;t<this.cards.length;t++)if(this.cards[t].name===e)return this.cards[t];return e===ls.name?ls:this._createUnknownCard(e)}_createUnknownCard(e){return{name:e,type:hs,render:this.unknownCardHandler}}_createCardArgument(e,t={}){return{env:{name:e.name,isInEditor:!1,dom:this.dom,didRender:e=>this._registerRenderCallback(e),onTeardown:e=>this._registerTeardownCallback(e)},options:this.cardOptions,payload:t}}_registerRenderCallback(e){this._renderCallbacks.push(e)}_registerTeardownCallback(e){this._teardownCallbacks.push(e)}renderCardSection([e,t,r]){let s=this.findCard(t),i=this._createCardArgument(s,r),n=s.render(i);return this._validateCardRender(n,s.name),n}_validateCardRender(e,t){if(e&&"object"!==typeof e)throw new Error(`Card "${t}" must render dom, but result was "${e}"`)}renderMarkupSection([e,t,r]){if(!fs(t=t.toLowerCase(),1))return;let s=this.sectionElementRendererFor(t)(t,this.dom);return this.renderMarkersOnElement(s,r),s}sectionElementRendererFor(e){return this.sectionElementRenderer[e]||this.sectionElementRenderer.__default__}}const vs="0.3.0",Ns="0.3.1",Ts="0.3.2";class Rs{constructor(e,t){let{cards:r,cardOptions:s,atoms:i,unknownCardHandler:n,unknownAtomHandler:a,markupElementRenderer:o,sectionElementRenderer:h,dom:l}=t,{version:d,sections:c,atoms:u,cards:p,markups:m}=e;!function(e){switch(e){case vs:case Ns:case Ts:return;default:throw new Error(`Unexpected Mobiledoc version "${e}"`)}}(d),this.dom=l,this.root=this.dom.createDocumentFragment(),this.sections=c,this.atomTypes=u,this.cardTypes=p,this.markerTypes=m,this.cards=r,this.atoms=i,this.cardOptions=s,this.unknownCardHandler=n||this._defaultUnknownCardHandler,this.unknownAtomHandler=a||this._defaultUnknownAtomHandler,this.sectionElementRenderer={__default__:As},Object.keys(h).forEach((e=>{this.sectionElementRenderer[e.toLowerCase()]=h[e]})),this.markupElementRenderer={__default__:ys},Object.keys(o).forEach((e=>{this.markupElementRenderer[e.toLowerCase()]=o[e]})),this._renderCallbacks=[],this._teardownCallbacks=[]}get _defaultUnknownCardHandler(){return({env:{name:e}})=>{throw new Error(`Card "${e}" not found but no unknownCardHandler was registered`)}}get _defaultUnknownAtomHandler(){return({env:{name:e}})=>{throw new Error(`Atom "${e}" not found but no unknownAtomHandler was registered`)}}render(){this.sections.forEach((e=>{let t=this.renderSection(e);t&&this.root.appendChild(t)}));for(let e=0;e<this._renderCallbacks.length;e++)this._renderCallbacks[e]();return this._renderedChildNodes=Array.prototype.slice.call(this.root.childNodes),{result:this.root,teardown:()=>this.teardown()}}teardown(){for(let e=0;e<this._teardownCallbacks.length;e++)this._teardownCallbacks[e]();for(let e=0;e<this._renderedChildNodes.length;e++){let t=this._renderedChildNodes[e];t.parentNode&&t.parentNode.removeChild(t)}}renderSection(e){const[t]=e;switch(t){case 1:return this.renderMarkupSection(e);case 2:return this.renderImageSection(e);case 3:return this.renderListSection(e);case 10:return this.renderCardSection(e);default:throw new Error(`Cannot render mobiledoc section of type "${t}"`)}}renderMarkersOnElement(e,t){let r=[e],s=e;for(let n=0,a=t.length;n<a;n++){let e=t[n],[a,o,h,l]=e;for(let t=0,n=o.length;t<n;t++){let e=this.markerTypes[o[t]],[n,a=[]]=e;ks(n)?(i=this.renderMarkupElement(n,a),s.appendChild(i),r.push(i),s=i):h--}switch(a){case 0:s.appendChild(as(this.dom,l));break;case 1:s.appendChild(this._renderAtom(l));break;default:throw new Error(`Unknown markup type (${a})`)}for(let t=0,i=h;t<i;t++)r.pop(),s=r[r.length-1]}var i}renderMarkupElement(e,t){return e=e.toLowerCase(),t=bs(t),this.markupElementRendererFor(e)(e,this.dom,t)}markupElementRendererFor(e){return this.markupElementRenderer[e]||this.markupElementRenderer.__default__}renderListItem(e){const t=this.dom.createElement("li");return this.renderMarkersOnElement(t,e),t}renderListSection([e,t,r]){if(!fs(t,3))return;const s=this.dom.createElement(t);return r.forEach((e=>{s.appendChild(this.renderListItem(e))})),s}renderImageSection([e,t]){let r=this.dom.createElement("img");return r.src=t,r}findCard(e){for(let t=0;t<this.cards.length;t++)if(this.cards[t].name===e)return this.cards[t];return e===ls.name?ls:this._createUnknownCard(e)}_findCardByIndex(e){let t=this.cardTypes[e];if(!t)throw new Error(`No card definition found at index ${e}`);let[r,s]=t;return{card:this.findCard(r),payload:s}}_createUnknownCard(e){return{name:e,type:hs,render:this.unknownCardHandler}}_createCardArgument(e,t={}){return{env:{name:e.name,isInEditor:!1,dom:this.dom,didRender:e=>this._registerRenderCallback(e),onTeardown:e=>this._registerTeardownCallback(e)},options:this.cardOptions,payload:t}}_registerTeardownCallback(e){this._teardownCallbacks.push(e)}_registerRenderCallback(e){this._renderCallbacks.push(e)}renderCardSection([e,t]){let{card:r,payload:s}=this._findCardByIndex(t),i=this._createCardArgument(r,s),n=r.render(i);return this._validateCardRender(n,r.name),n}_validateCardRender(e,t){if(e&&"object"!==typeof e)throw new Error(`Card "${t}" must render dom, but result was "${e}"`)}findAtom(e){for(let t=0;t<this.atoms.length;t++)if(this.atoms[t].name===e)return this.atoms[t];return this._createUnknownAtom(e)}_createUnknownAtom(e){return{name:e,type:hs,render:this.unknownAtomHandler}}_createAtomArgument(e,t,r){return{env:{name:e.name,isInEditor:!1,dom:this.dom,onTeardown:e=>this._registerTeardownCallback(e)},options:this.cardOptions,value:t,payload:r}}_validateAtomRender(e,t){if(e&&"object"!==typeof e)throw new Error(`Atom "${t}" must render dom, but result was "${e}"`)}_findAtomByIndex(e){let t=this.atomTypes[e];if(!t)throw new Error(`No atom definition found at index ${e}`);let[r,s,i]=t;return{atom:this.findAtom(r),value:s,payload:i}}_renderAtom(e){let{atom:t,value:r,payload:s}=this._findAtomByIndex(e),i=this._createAtomArgument(t,r,s),n=t.render(i);return this._validateAtomRender(n,t.name),n||as(this.dom,"")}renderMarkupSection([e,t,r,s=[]]){if(!fs(t=t.toLowerCase(),1))return;let i=bs(s),n=this.sectionElementRendererFor(t)(t,this.dom,i);return this.renderMarkersOnElement(n,r),n}sectionElementRendererFor(e){return this.sectionElementRenderer[e]||this.sectionElementRenderer.__default__}}class Is{constructor({cards:e=[],atoms:t=[],cardOptions:r={},unknownCardHandler:s,unknownAtomHandler:i,markupElementRenderer:n={},sectionElementRenderer:a={},dom:o,markupSanitizer:h=null}={}){if(function(e){if(!Array.isArray(e))throw new Error("`cards` must be passed as an array");for(let t=0;t<e.length;t++){let r=e[t];if(r.type!==hs)throw new Error(`Card "${r.name}" must be of type "dom", was "${r.type}"`);if(!r.render)throw new Error(`Card "${r.name}" must define \`render\``)}}(e),function(e){if(!Array.isArray(e))throw new Error("`atoms` must be passed as an array");for(let t=0;t<e.length;t++){let r=e[t];if(r.type!==hs)throw new Error(`Atom "${r.name}" must be type "dom", was "${r.type}"`);if(!r.render)throw new Error(`Atom "${r.name}" must define \`render\``)}}(t),!o){if("undefined"===typeof window)throw new Error("A `dom` option must be provided to the renderer when running without window.document");o=window.document}this.options={cards:e,atoms:t,cardOptions:r,unknownCardHandler:s,unknownAtomHandler:i,markupElementRenderer:n,sectionElementRenderer:a,dom:o,markupSanitizer:h}}render(e){let{version:t}=e;switch(t){case Ms:case void 0:case null:return new ws(e,this.options).render();case vs:case Ns:case Ts:return new Rs(e,this.options).render();default:throw new Error(`Unexpected Mobiledoc version "${t}"`)}}}var Ls={name:"image-card",type:"text",render(){}},xs="text";const Ds="0.2.0";class Os{constructor(e,t){let{cards:r,cardOptions:s,atoms:i,unknownCardHandler:n}=t,{version:a,sections:o}=e;!function(e){if(e!==Ds)throw new Error(`Unexpected Mobiledoc version "${e}"`)}(a);let[,h]=o;this.root=[],this.sections=h,this.cards=r,this.atoms=i,this.cardOptions=s,this.unknownCardHandler=n||this._defaultUnknownCardHandler,this._teardownCallbacks=[]}render(){return this.sections.forEach((e=>{this.root.push(this.renderSection(e))})),{result:this.root.join("\n"),teardown:()=>this.teardown()}}teardown(){for(let e=0;e<this._teardownCallbacks.length;e++)this._teardownCallbacks[e]()}get _defaultUnknownCardHandler(){return()=>{}}renderSection(e){const[t]=e;switch(t){case 1:return this.renderMarkupSection(e);case 2:return this.renderImageSection(e);case 3:return this.renderListSection(e);case 10:return this.renderCardSection(e);default:throw new Error("Unimplemented renderer for type "+t)}}renderImageSection(){return""}renderListSection([e,t,r]){return r.map((e=>this.renderListItem(e))).join("\n")}renderListItem(e){return this.renderMarkers(e)}findCard(e){for(let t=0;t<this.cards.length;t++)if(this.cards[t].name===e)return this.cards[t];return e===Ls.name?Ls:this._createUnknownCard(e)}_createUnknownCard(e){return{name:e,type:xs,render:this.unknownCardHandler}}renderCardSection([e,t,r]){let s=this.findCard(t),i=this._createCardArgument(s,r),n=s.render(i);return this._validateCardRender(n,s.name),n||""}_validateCardRender(e,t){if(e&&"string"!==typeof e)throw new Error(`Card "${t}" must render text, but result was ${typeof e}"`)}_registerTeardownCallback(e){this._teardownCallbacks.push(e)}_createCardArgument(e,t={}){return{env:{name:e.name,isInEditor:!1,onTeardown:e=>this._registerTeardownCallback(e)},options:this.cardOptions,payload:t}}renderMarkupSection([e,t,r]){return this.renderMarkers(r)}renderMarkers(e){let t="";return e.forEach((e=>{let[,,r]=e;t+=r})),t}}const Ps="0.3.0",Bs="0.3.1",Hs="0.3.2";class Fs{constructor(e,t){let{cards:r,cardOptions:s,atoms:i,unknownCardHandler:n,unknownAtomHandler:a}=t,{version:o,sections:h,atoms:l,cards:d}=e;!function(e){if(e!==Ps&&e!==Bs&&e!==Hs)throw new Error(`Unexpected Mobiledoc version "${e}"`)}(o),this.root=[],this.sections=h,this.atomTypes=l,this.cardTypes=d,this.cards=r,this.atoms=i,this.cardOptions=s,this.unknownCardHandler=n||this._defaultUnknownCardHandler,this.unknownAtomHandler=a||this._defaultUnknownAtomHandler,this._teardownCallbacks=[]}render(){return this.sections.forEach((e=>{this.root.push(this.renderSection(e))})),{result:this.root.join("\n"),teardown:()=>this.teardown()}}teardown(){for(let e=0;e<this._teardownCallbacks.length;e++)this._teardownCallbacks[e]()}get _defaultUnknownCardHandler(){return()=>{}}get _defaultUnknownAtomHandler(){return({value:e})=>e||""}renderSection(e){const[t]=e;switch(t){case 1:return this.renderMarkupSection(e);case 2:return this.renderImageSection(e);case 3:return this.renderListSection(e);case 10:return this.renderCardSection(e);default:throw new Error("Unimplemented renderer for type "+t)}}renderImageSection(){return""}renderListSection([e,t,r]){return r.map((e=>this.renderListItem(e))).join("\n")}renderListItem(e){return this.renderMarkers(e)}findCard(e){for(let t=0;t<this.cards.length;t++)if(this.cards[t].name===e)return this.cards[t];return e===Ls.name?Ls:this._createUnknownCard(e)}_findCardByIndex(e){let t=this.cardTypes[e];if(!t)throw new Error(`No card definition found at index ${e}`);let[r,s]=t;return{card:this.findCard(r),payload:s}}_createUnknownCard(e){return{name:e,type:xs,render:this.unknownCardHandler}}renderCardSection([e,t]){let{card:r,payload:s}=this._findCardByIndex(t),i=this._createCardArgument(r,s),n=r.render(i);return this._validateCardRender(n,r.name),n||""}_validateCardRender(e,t){if(e&&"string"!==typeof e)throw new Error(`Card "${t}" must render text, but result was ${typeof e}"`)}_registerTeardownCallback(e){this._teardownCallbacks.push(e)}_createCardArgument(e,t={}){return{env:{name:e.name,isInEditor:!1,onTeardown:e=>this._registerTeardownCallback(e)},options:this.cardOptions,payload:t}}renderMarkupSection([e,t,r]){return this.renderMarkers(r)}findAtom(e){for(let t=0;t<this.atoms.length;t++)if(this.atoms[t].name===e)return this.atoms[t];return this._createUnknownAtom(e)}_createUnknownAtom(e){return{name:e,type:xs,render:this.unknownAtomHandler}}_createAtomArgument(e,t,r){return{env:{name:e.name,onTeardown:e=>this._registerTeardownCallback(e)},options:this.cardOptions,value:t,payload:r}}_validateAtomRender(e,t){if(e&&"string"!==typeof e)throw new Error(`Atom "${t}" must render text, but result was ${typeof e}"`)}_findAtomByIndex(e){let t=this.atomTypes[e];if(!t)throw new Error(`No atom definition found at index ${e}`);let[r,s,i]=t;return{atom:this.findAtom(r),value:s,payload:i}}_renderAtom(e){let{atom:t,value:r,payload:s}=this._findAtomByIndex(e),i=this._createAtomArgument(t,r,s),n=t.render(i);return this._validateAtomRender(n,t.name),n||""}renderMarkers(e){let t="";return e.forEach((e=>{let[r,,,s]=e;switch(r){case 0:t+=s;break;case 1:t+=this._renderAtom(s);break;default:throw new Error(`Unknown markup type (${r})`)}})),t}}class $s{constructor({cards:e,atoms:t,cardOptions:r,unknownCardHandler:s,unknownAtomHandler:i}={}){(function(e){if(!Array.isArray(e))throw new Error("`cards` must be passed as an array");for(let t=0;t<e.length;t++){let r=e[t];if(r.type!==xs)throw new Error(`Card "${r.name}" must be type "text", was "${r.type}"`);if(!r.render)throw new Error(`Card "${r.name}" must define \`render\``)}})(e=e||[]),function(e){if(!Array.isArray(e))throw new Error("`atoms` must be passed as an array");for(let t=0;t<e.length;t++){let r=e[t];if(r.type!==xs)throw new Error(`Atom "${r.name}" must be type "text", was "${r.type}"`);if(!r.render)throw new Error(`Atom "${r.name}" must define \`render\``)}}(t=t||[]),r=r||{},this.state={cards:e,atoms:t,cardOptions:r,unknownCardHandler:s,unknownAtomHandler:i}}render(e){let{version:t}=e;switch(t){case Ds:return new Os(e,this.state).render();case void 0:case null:case Ps:case Bs:case Hs:return new Fs(e,this.state).render();default:throw new Error(`Unexpected Mobiledoc version "${t}"`)}}}class Us{constructor(e,t){this.type=e,this.manager=t}isEnabled(){return this.manager.isEnabled(this.type)}log(...e){e.unshift(`[${this.type}]`),this.isEnabled()&&window.console.log(...e)}}class Ks{constructor(){this.enabledTypes=[],this.allEnabled=!1}for(e){return new Us(e,this)}enableAll(){this.allEnabled=!0}enableTypes(e){this.enabledTypes=this.enabledTypes.concat(e)}disable(){this.enabledTypes=[],this.allEnabled=!1}isEnabled(e){return this.allEnabled||-1!==this.enabledTypes.indexOf(e)}}const Ws={placeholder:"Write here...",spellcheck:!0,autofocus:!0,showLinkTooltips:!0,undoDepth:5,undoBlockTimeout:5e3,cards:[],atoms:[],cardOptions:{},unknownCardHandler:({env:e})=>{throw new N(`Unknown card encountered: ${e.name}`)},unknownAtomHandler:({env:e})=>{throw new N(`Unknown atom encountered: ${e.name}`)},mobiledoc:null,html:null,tooltipPlugin:_e},js={DID_UPDATE:"didUpdate",WILL_RENDER:"willRender",DID_RENDER:"didRender",WILL_DELETE:"willDelete",DID_DELETE:"didDelete",WILL_HANDLE_NEWLINE:"willHandleNewline",CURSOR_DID_CHANGE:"cursorDidChange",DID_REPARSE:"didReparse",POST_DID_CHANGE:"postDidChange",INPUT_MODE_DID_CHANGE:"inputModeDidChange",WILL_COPY:"willCopy"};var qs,Gs;!function(e){e.MOBILEDOC="mobiledoc",e.HTML="html",e.TEXT="text"}(qs||(qs={})),function(e){e.CHAR="char",e.WORD="word"}(Gs||(Gs={}));class Vs{constructor(e={}){T("editor create accepts an options object. For legacy usage passing an element for the first argument, consider the `html` option for loading DOM or HTML posts. For other cases call `editor.render(domNode)` after editor creation",e&&!e.nodeType),this._views=[],this.isEditable=!0,this._parserPlugins=e.parserPlugins||[],function(e,t,r){Object.assign(e,t,r)}(this,Ws,e),this.cards.push(it),Ir.forEach((e=>this.registerKeyCommand(e))),this._logManager=new Ks,this._parser=new mr(this.builder);let{cards:t,atoms:r,unknownCardHandler:s,unknownAtomHandler:i,cardOptions:n}=this;this._renderer=new Xt(this,t,r,s,i,n),this.post=this.loadPost(),this._renderTree=new Cr(this.post),this._editHistory=new Hr(this,this.undoDepth,this.undoBlockTimeout),this._eventManager=new is(this),this._mutationHandler=new Dr(this),this._editState=new ns(this),this._callbacks=new Ce(p(js)),this._beforeHooks={toggleMarkup:[]},this._isComposingOnBlankLine=!1,Nr.forEach((e=>this.onTextInput(e))),this.hasRendered=!1,this.isDestroyed=!1}enableLogging(e=[]){0===e.length?this._logManager.enableAll():this._logManager.enableTypes(e)}disableLogging(){this._logManager.disable()}loggerFor(e){return this._logManager.for(e)}get builder(){return this._builder||(this._builder=new wr),this._builder}loadPost(){let{mobiledoc:e,html:t}=this;if(e)return Nt.parse(this.builder,e);if(t){if("string"===typeof t){let e={plugins:this._parserPlugins};return new fr(this.builder,e).parse(t)}{let e=t;return this._parser.parse(e)}}return this.builder.createPost([this.builder.createMarkupSection()])}rerender(){let e=this.post.renderNode;e.element||(T("Must call `render` before `rerender` can be called",this.hasRendered),e.element=this.element,e.markDirty()),this.runCallbacks(js.WILL_RENDER),this._mutationHandler.suspendObservation((()=>{this._renderer.render(this._renderTree)})),this.runCallbacks(js.DID_RENDER)}render(e){T("Cannot render an editor twice. Use `rerender` to update the rendering of an existing editor instance.",!this.hasRendered),e.spellcheck=this.spellcheck,function(e){for(;e.childNodes.length;)e.removeChild(e.childNodes[0])}(e),this.element=e,this.showLinkTooltips&&this._addTooltip(),this.run((()=>{})),this.hasRendered=!0,this.rerender(),this._mutationHandler.init(),this._eventManager.init(),!1===this.isEditable?this.disableEditing():this.enableEditing(),this.autofocus&&this.selectRange(this.post.headPosition())}_addTooltip(){this.addView(new ge({rootElement:this.element,showForTag:"a",editor:this}))}get keyCommands(){return this._keyCommands||(this._keyCommands=[]),this._keyCommands}registerKeyCommand(e){const t=xr(e);T("Key Command is not valid",function(e){return!!e.code&&!!e.run}(t)),this.keyCommands.unshift(t)}unregisterKeyCommands(e){for(let t=this.keyCommands.length-1;t>-1;t--){this.keyCommands[t].name===e&&this.keyCommands.splice(t,1)}}deleteAtPosition(e,t,{unit:r}){this.run((s=>{let i=s.deleteAtPosition(e,t,{unit:r});s.setRange(i)}))}deleteRange(e){this.run((t=>{let r=t.deleteRange(e);t.setRange(r)}))}performDelete({direction:e,unit:t}={direction:$.BACKWARD,unit:Gs.CHAR}){const{range:r}=this;this.runCallbacks(js.WILL_DELETE,[r,e,t]),r.isCollapsed?this.deleteAtPosition(r.head,e,{unit:t}):this.deleteRange(r),this.runCallbacks(js.DID_DELETE,[r,e,t])}handleNewline(e){if(!this.hasCursor())return;e.preventDefault();let{range:t}=this;this.run((e=>{let r;if(!t.isCollapsed){if(r=e.deleteRange(t).section,r&&r.isBlank)return void e.setRange(r.headPosition())}let s=!1;const i={preventDefault(){s=!0}};this.runCallbacks(js.WILL_HANDLE_NEWLINE,[i]),s||(r=e.splitSection(t.head)[1],e.setRange(r.headPosition()))}))}_postDidChange(){this.runCallbacks(js.POST_DID_CHANGE)}selectRange(e){e=ve(e),this.cursor.selectRange(e),this.range=e}get cursor(){return new Ne(this)}get range(){return this._editState.range}set range(e){this._editState.updateRange(e),this._editState.rangeDidChange()&&this._rangeDidChange(),this._editState.inputModeDidChange()&&this._inputModeDidChange()}_readRangeFromDOM(){this.range=this.cursor.offsets}setPlaceholder(e){!function(e,t,r){if(!e.dataset){const s=t.replace(/[A-Z]/g,((e,t)=>{const r=e.toLowerCase();return 0===t?r:"-"+r}));return e.setAttribute(s,r)}e.dataset[t]=r}(this.element,"placeholder",e)}_reparsePost(){let e=this._parser.parse(this.element);this.run((t=>{t.removeAllSections(),t.migrateSectionsFromPost(e),t.setRange(z.blankRange())})),this.runCallbacks(js.DID_REPARSE),this._postDidChange()}_reparseSections(e=[]){let t;e.forEach((e=>{this._parser.reparseSection(e,this._renderTree)})),this._removeDetachedSections(),this._renderTree.isDirty&&(t=this.range);const r=this._editHistory._pendingSnapshot,s=r.range;this.run((()=>{r.range=s})),this.rerender(),t&&this.selectRange(t),this.runCallbacks(js.DID_REPARSE),this._postDidChange()}_removeDetachedSections(){n(a(this.post.sections,(e=>!e.renderNode.isAttached())),(e=>e.renderNode.scheduleForRemoval()))}get activeSections(){return this._editState.activeSections}get activeSection(){const{activeSections:e}=this;return e[e.length-1]}get activeSectionAttributes(){return this._editState.activeSectionAttributes}detectMarkupInRange(e,t){return s(this.post.markupsInRange(e),(e=>e.hasTag(t)))}get activeMarkups(){return this._editState.activeMarkups}hasActiveMarkup(e){let t;if("string"===typeof e){let r=A(e);t=e=>e.tagName===r}else t=t=>t===e;return!!s(this.activeMarkups,t)}serialize(e="0.3.2"){return this.serializePost(this.post,qs.MOBILEDOC,{version:e})}serializeTo(e){let t=this.post;return this.serializePost(t,e)}serializePost(e,t,r={}){if(T(`Unrecognized serialization format ${t}`,u(Object.values(qs),t)),t===qs.MOBILEDOC){let t=r.version||br;return Sr.render(e,t)}{let s=this.serializePost(e,qs.MOBILEDOC),i={unknownCardHandler:()=>{},unknownAtomHandler:()=>{}};switch(t){case qs.HTML:if(Er.hasDOM()){return`<div>${function(e){const t=document.createElement("div");return t.appendChild(e),t.innerHTML}(new Is(i).render(s).result)}</div>`}return this.serializePost(e,qs.TEXT,r);case qs.TEXT:return new $s(i).render(s).result}}}addView(e){this._views.push(e)}removeAllViews(){this._views.forEach((e=>e.destroy())),this._views=[]}hasCursor(){return this.cursor.hasCursor()}destroy(){this.isDestroyed=!0,this._hasSelection()&&this.cursor.clearSelection(),this._hasFocus()&&this.element.blur(),this._mutationHandler.destroy(),this._eventManager.destroy(),this.removeAllViews(),this._renderer.destroy(),this._editState.destroy()}disableEditing(){this.isEditable=!1,this.hasRendered&&(this._eventManager.stop(),this.element.setAttribute("contentEditable","false"),this.setPlaceholder(""),this.selectRange(z.blankRange()))}enableEditing(){this.isEditable=!0,this.hasRendered&&(this._eventManager.start(),this.element.setAttribute("contentEditable","true"),this.setPlaceholder(this.placeholder))}editCard(e){this._setCardMode(e,ee.EDIT)}displayCard(e){this._setCardMode(e,ee.DISPLAY)}run(e){const t=new st(this);t.begin(),this._editHistory.snapshot();const r=e(t);return this.runCallbacks(js.DID_UPDATE,[t]),t.complete(),this._readRangeFromDOM(),t._shouldCancelSnapshot&&(this._editHistory._pendingSnapshot=null),this._editHistory.storeSnapshot(t.editActionTaken),r}didUpdatePost(e){this.addCallback(js.DID_UPDATE,e)}postDidChange(e){this.addCallback(js.POST_DID_CHANGE,e)}onTextInput(e){this._eventManager.registerInputHandler(e)}unregisterAllTextInputHandlers(){this._eventManager.unregisterAllTextInputHandlers()}unregisterTextInputHandler(e){this._eventManager.unregisterInputHandler(e)}inputModeDidChange(e){this.addCallback(js.INPUT_MODE_DID_CHANGE,e)}willRender(e){this.addCallback(js.WILL_RENDER,e)}didRender(e){this.addCallback(js.DID_RENDER,e)}willCopy(e){this.addCallback(js.WILL_COPY,e)}willDelete(e){this.addCallback(js.WILL_DELETE,e)}didDelete(e){this.addCallback(js.DID_DELETE,e)}willHandleNewline(e){this.addCallback(js.WILL_HANDLE_NEWLINE,e)}cursorDidChange(e){this.addCallback(js.CURSOR_DID_CHANGE,e)}_rangeDidChange(){this.hasRendered&&this.runCallbacks(js.CURSOR_DID_CHANGE)}_inputModeDidChange(){this.runCallbacks(js.INPUT_MODE_DID_CHANGE)}_insertEmptyMarkupSectionAtCursor(){this.run((e=>{const t=e.builder.createMarkupSection("p");e.insertSectionBefore(this.post.sections,t),e.setRange(t.toRange())}))}beforeToggleMarkup(e){this._beforeHooks.toggleMarkup.push(e)}toggleMarkup(e,t={}){const r=this.builder.createMarkup(e,t),{range:s}=this,i=!this.detectMarkupInRange(s,r.tagName);this._runBeforeHooks("toggleMarkup",{markup:r,range:s,willAdd:i})||(s.isCollapsed?(this._editState.toggleMarkupState(r),this._inputModeDidChange(),this._ensureFocus()):this.run((e=>e.toggleMarkup(r,s))))}_ensureFocus(){this._hasSelection()&&!this._hasFocus()&&this.focus()}focus(){this.element.focus()}_hasSelection(){const{cursor:e}=this;return this.hasRendered&&(e._hasCollapsedSelection()||e._hasSelection())}_hasFocus(){return document.activeElement===this.element}toggleSection(e){this.run((t=>t.toggleSection(e,this.range)))}setAttribute(e,t){this.run((r=>r.setAttribute(e,t,this.range)))}removeAttribute(e){this.run((t=>t.removeAttribute(e,this.range)))}handleKeyCommand(e){const t=function(e,t){const r=W.fromEvent(t);return a(e,(({modifierMask:e,code:t})=>r.keyCode===t&&r.modifierMask===e))}(this.keyCommands,e);for(let r=0;r<t.length;r++){if(!1!==t[r].run(this))return e.preventDefault(),!0}return!1}insertText(e){if(!this.hasCursor())return;this.post.isBlank&&this._insertEmptyMarkupSectionAtCursor();let{activeMarkups:t,range:r,range:{head:s}}=this;this.run((i=>{r.isCollapsed||(s=i.deleteRange(r)),i.insertTextWithMarkup(s,e,t)}))}insertAtom(e,t="",r={}){if(!this.hasCursor())return;let s;this.post.isBlank&&this._insertEmptyMarkupSectionAtCursor();let{range:i}=this;return this.run((n=>{let a=i.head;s=n.builder.createAtom(e,t,r),i.isCollapsed||(a=n.deleteRange(i)),n.insertMarkers(a,[s])})),s}insertCard(e,t={},r=!1){if(!this.hasCursor())return;let s;this.post.isBlank&&this._insertEmptyMarkupSectionAtCursor();let{range:i}=this;return this.run((n=>{let a=i.tail;s=n.builder.createCardSection(e,t),r&&this.editCard(s),i.isCollapsed||(a=n.deleteRange(i));let o=a.section;if(X(o)&&(o=o.parent),o.isBlank)n.replaceSection(o,s);else{let e=this.post.sections;n.insertSectionBefore(e,s,o.next)}n.setRange(s.tailPosition())})),s}positionAtPoint(e,t){return ce.atPoint(e,t,this)}_setCardMode(e,t){const r=e.renderNode;if(r&&r.isRendered){r.cardNode[t]()}else e.setInitialMode(t)}triggerEvent(e,t,r){this._eventManager._trigger(e,t,r)}addCallback(e,t){this._callbacks.addCallback(e,t)}addCallbackOnce(e,t){this._callbacks.addCallbackOnce(e,t)}runCallbacks(e,t){this.isDestroyed||this._callbacks.runCallbacks(e,t)}_runBeforeHooks(e,...t){let r=this._beforeHooks[e]||[];for(let s=0;s<r.length;s++)if(!1===r[s](...t))return!0}}}}]);